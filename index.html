<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DRIS//core VNGRD v22.1 // HYBRID BROADCAST</title>
    <!--
    ═══════════════════════════════════════════════════════════════════════════
    DRISCORE_VNGRD_v22.1 // HYBRID BROADCAST MONSTER
    ═══════════════════════════════════════════════════════════════════════════
    Build: 22.1.0 | Hybrid Layer Architecture
    Features: Canvas VJ + HTML Overlays + Impact Physics + Carousel Mode
    ═══════════════════════════════════════════════════════════════════════════
    -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800;900&family=JetBrains+Mono:wght@300;400;500&family=Bebas+Neue&family=Russo+One&display=swap');
        
        :root { 
            --accent: #00f3ff;
            --accent-dim: rgba(0, 243, 255, 0.2);
            --accent-glow: rgba(0, 243, 255, 0.5);
            --p: #ff0055; --c: #00f3ff; --g: #00ff88; --y: #ffcc00; --r: #ff3333; --o: #ff9d00; --v: #b000ff;
            --bg: #050508; --panel: #08080c; --panel-light: #0c0c12; --border: #151520; --border-light: #202030;
            --text: #a0a0a8; --text-dim: #505058; --text-bright: #e8e8ec;
        }
        
        /* THEMES */
        body.theme-magenta { --accent: #ff0055; --accent-dim: rgba(255,0,85,0.2); --accent-glow: rgba(255,0,85,0.5); }
        body.theme-green { --accent: #00ff88; --accent-dim: rgba(0,255,136,0.2); --accent-glow: rgba(0,255,136,0.5); }
        body.theme-purple { --accent: #b000ff; --accent-dim: rgba(176,0,255,0.2); --accent-glow: rgba(176,0,255,0.5); }
        body.theme-gold { --accent: #ffd700; --accent-dim: rgba(255,215,0,0.2); --accent-glow: rgba(255,215,0,0.5); }
        body.theme-night { --accent: #334455; --accent-dim: rgba(51,68,85,0.2); --bg: #020204; --panel: #040408; }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { 
            background: var(--bg); color: var(--text); 
            font-family: 'JetBrains Mono', monospace; 
            overflow: hidden; height: 100vh; width: 100vw; font-size: 12px;
            overscroll-behavior: none; touch-action: none;
        }
        
        * { -webkit-user-drag: none; user-select: none; }
        input, textarea { user-select: text; }

        /* SEISMIC SHAKE - Heavy 3D Physics */
        body.bass-hit { animation: seismic-shake 0.1s ease; }
        @keyframes seismic-shake { 
            0%, 100% { transform: translate3d(0, 0, 0) rotate(0); } 
            25% { transform: translate3d(-8px, 6px, 0) rotate(-1.5deg); }
            50% { transform: translate3d(6px, -4px, 0) rotate(1.2deg); }
            75% { transform: translate3d(-4px, 3px, 0) rotate(-0.8deg); }
        }
        
        /* LOGO FLASH */
        body.logo-flash { animation: console-flash 0.4s ease; }
        @keyframes console-flash { 0% { filter: brightness(1); } 20% { filter: brightness(2.5); } 100% { filter: brightness(1); } }

        /* IMPACT FLASH - Theme Linked */
        body.impact-flash #stage { animation: impact-pulse 0.2s ease; }
        body.impact-flash .sidebar { animation: sidebar-flash 0.15s ease; }
        @keyframes impact-pulse { 0%,100% { filter: none; } 50% { filter: brightness(1.5) contrast(1.3) saturate(1.5); } }
        @keyframes sidebar-flash { 0%,100% { border-color: var(--border); } 50% { border-color: var(--accent); box-shadow: inset 0 0 30px var(--accent-dim); } }

        /* ═══════════════════════════════════════════════════════════════
           LOGO - 15 MORPHS (HTML OVERLAY)
           ═══════════════════════════════════════════════════════════════ */
        .logo { 
            font-family: 'Orbitron', sans-serif; 
            font-size: 36px; font-weight: 900;
            letter-spacing: -2px; color: #fff;
            cursor: pointer; user-select: none;
            transition: all 0.3s ease;
        }
        
        .logo:hover { transform: scale(1.05); filter: brightness(1.2); }
        
        .logo.m1 { color: #00f3ff; text-shadow: 0 0 20px #00f3ff, 0 0 40px #00f3ff; animation: pulse-glow 2s infinite; }
        .logo.m2 { color: #ff0055; text-shadow: 0 0 20px #ff0055, 0 0 40px #ff0055; animation: logo-float 3s infinite; }
        .logo.m3 { color: #00ff88; text-shadow: 0 0 20px #00ff88, 0 0 40px #00ff88; animation: shimmer 2.5s infinite; }
        .logo.m4 { color: #ffcc00; text-shadow: 0 0 25px #ffcc00, 0 0 50px #ffcc00; animation: electric-surge 1.5s infinite; }
        .logo.m5 { color: #ff6600; text-shadow: 0 0 20px #ff6600, 0 0 40px #ff6600; animation: fire-flicker 0.8s infinite; }
        .logo.m6 { color: #ffffff; text-shadow: 0 0 25px #fff, 0 0 50px #fff; animation: holy-glow 3s infinite; }
        .logo.m7 { color: #b000ff; text-shadow: 0 0 20px #b000ff, 0 0 40px #b000ff; animation: bounce 1s infinite; }
        .logo.m8 { color: #ff6b9d; text-shadow: 0 0 20px #ff6b9d, 0 0 40px #ff6b9d; animation: shimmer 2s infinite; }
        .logo.m9 { color: #00ffff; text-shadow: 0 0 25px #00ffff, 0 0 60px #00ffff; animation: electric-surge 2s infinite; }
        .logo.m10 { color: #7fff00; text-shadow: 0 0 20px #7fff00, 0 0 40px #7fff00; animation: logo-float 2.5s infinite; }
        .logo.m11 { color: #ff4500; text-shadow: 0 0 20px #ff4500, 0 0 40px #ff4500; animation: fire-flicker 0.6s infinite; }
        .logo.m12 { color: #ffd700; text-shadow: 0 0 30px #ffd700, 0 0 60px #ffd700; animation: gold-shine 3s infinite; }
        .logo.m13 { color: #ff1493; text-shadow: 0 0 20px #ff1493, 0 0 40px #ff1493; animation: heartbeat 1.2s infinite; }
        .logo.m14 { color: #00bfff; text-shadow: 0 0 20px #00bfff, 0 0 40px #00bfff; animation: wave 2s infinite; }
        .logo.m15 { background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #8b00ff); -webkit-background-clip: text; background-clip: text; color: transparent; animation: rainbow-shift 3s linear infinite; }
        
        @keyframes pulse-glow { 0%,100% { opacity: 1; } 50% { opacity: 0.85; filter: brightness(1.3); } }
        @keyframes logo-float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        @keyframes shimmer { 0%,100% { filter: brightness(1); } 50% { filter: brightness(1.4); } }
        @keyframes electric-surge { 0%,100% { text-shadow: 0 0 20px currentColor; } 50% { text-shadow: 0 0 40px currentColor, 0 0 80px currentColor; } }
        @keyframes fire-flicker { 0%,100% { opacity: 1; } 50% { opacity: 0.9; transform: scale(1.01); } }
        @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes gold-shine { 0%,100% { filter: brightness(1); } 50% { filter: brightness(1.5); } }
        @keyframes holy-glow { 0%,100% { text-shadow: 0 0 25px #fff; } 50% { text-shadow: 0 0 50px #fff, 0 0 100px #fff; } }
        @keyframes heartbeat { 0%,100% { transform: scale(1); } 14%,42% { transform: scale(1.05); } }
        @keyframes wave { 0%,100% { transform: translateY(0); } 25% { transform: translateY(-2px) rotate(1deg); } 75% { transform: translateY(2px) rotate(-1deg); } }
        @keyframes rainbow-shift { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        .sub-tag { 
            font-size: 11px; letter-spacing: 3px; color: var(--accent); margin-left: 10px; 
            opacity: 0.7;
            position: relative;
            display: inline-block;
            overflow: hidden;
        }
        
        .sub-tag::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: vngrd-shine 8s ease-in-out infinite;
        }
        
        @keyframes vngrd-shine {
            0%, 85%, 100% { left: -100%; opacity: 0; }
            90%, 95% { opacity: 1; }
            92% { left: 150%; }
        }
        .version { font-size: 10px; color: var(--accent); padding: 3px 8px; background: var(--accent-dim); border: 1px solid var(--accent); margin-left: 10px; }

        /* ═══════════════════════════════════════════════════════════════
           STAGE - LAYERED ARCHITECTURE
           Z-INDEX: Canvas(1000) < Overlays(2000) < UI(5000)
           ═══════════════════════════════════════════════════════════════ */
        #stage { 
            position: fixed; top: 45px; left: 200px; right: 200px; bottom: 55px;
            background: #000; border: 1px solid var(--border);
            overflow: hidden;
        }
        
        /* CANVAS LAYER - Z:1000 */
        #vj-canvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1000;
        }
        
        /* OVERLAY LAYER - Z:2000 (Sharp HTML) */
        #overlay-layer {
            position: absolute; inset: 0;
            z-index: 2000; pointer-events: none;
        }
        
        /* Scanlines */
        #stage::before {
            content: ""; position: absolute; inset: 0; z-index: 3000; pointer-events: none;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
            opacity: 0.3;
        }
        
        /* Vignette */
        #stage::after {
            content: ""; position: absolute; inset: 0; z-index: 3001; pointer-events: none;
            background: radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,0.5) 100%);
        }

        /* Fullscreen */
        body.fullscreen #stage { position: fixed; inset: 0; z-index: 9999; border: none; }
        body.fullscreen .sidebar, body.fullscreen #top-bar, body.fullscreen #bottom-bar { opacity: 0; pointer-events: none; }
        body.fullscreen #overlay-layer { z-index: 10000; }

        /* ═══════════════════════════════════════════════════════════════
           LOWER THIRDS - PREMIUM HTML OVERLAY
           ═══════════════════════════════════════════════════════════════ */
        #lower-third {
            position: absolute;
            bottom: 80px; left: 40px;
            z-index: 2500;
            pointer-events: none;
        }
        
        /* Stage 1: Accent Line Wipe */
        #lower-third::before {
            content: '';
            position: absolute;
            bottom: 0; left: 0;
            width: 100%; height: 3px;
            background: var(--accent);
            box-shadow: 0 0 20px var(--accent);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #lower-third.visible::before {
            transform: scaleX(1);
        }
        
        /* Stage 2: Container Unfold */
        .lt-container {
            display: flex; flex-direction: column;
            backdrop-filter: blur(20px);
            background: linear-gradient(135deg, rgba(0,0,0,0.85) 0%, rgba(20,20,30,0.9) 100%);
            border: 1px solid var(--accent);
            border-left: 4px solid var(--accent);
            box-shadow: 0 0 40px var(--accent-dim), 0 10px 40px rgba(0,0,0,0.5);
            padding: 15px 30px 15px 20px;
            min-width: 350px;
            max-width: 550px;
            clip-path: inset(100% 0 0 0);
            opacity: 0;
            transition: clip-path 0.4s cubic-bezier(0.4, 0, 0.2, 1) 0.2s, opacity 0.3s ease 0.2s;
        }
        
        #lower-third.visible .lt-container {
            clip-path: inset(0 0 0 0);
            opacity: 1;
        }
        
        /* Stage 3: Typography Animation */
        .lt-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 28px; font-weight: 800;
            color: #fff;
            text-shadow: 0 0 20px var(--accent), 2px 2px 4px rgba(0,0,0,0.8);
            letter-spacing: -2px;
            line-height: 1.1;
            margin-bottom: 4px;
            opacity: 0;
            transition: letter-spacing 0.5s ease 0.5s, opacity 0.4s ease 0.45s;
        }
        
        #lower-third.visible .lt-title {
            letter-spacing: 1px;
            opacity: 1;
        }
        
        .lt-subtitle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent-glow);
            letter-spacing: -1px;
            text-transform: uppercase;
            opacity: 0;
            transition: letter-spacing 0.4s ease 0.6s, opacity 0.3s ease 0.55s;
        }
        
        #lower-third.visible .lt-subtitle {
            letter-spacing: 2px;
            opacity: 1;
        }
        
        .lt-accent {
            position: absolute;
            top: 0; left: 0; bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, var(--accent) 0%, var(--p) 50%, var(--g) 100%);
            animation: lt-accent-pulse 2s ease-in-out infinite;
        }
        
        @keyframes lt-accent-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* Lower Third Presets */
        .lt-container.lt-guest { border-color: var(--c); }
        .lt-container.lt-guest .lt-subtitle { color: var(--c); }
        
        .lt-container.lt-track { border-color: var(--g); background: linear-gradient(135deg, rgba(0,20,10,0.9) 0%, rgba(0,40,20,0.85) 100%); }
        .lt-container.lt-track .lt-title { font-size: 22px; }
        .lt-container.lt-track .lt-subtitle { color: var(--g); font-size: 12px; }
        
        .lt-container.lt-breaking { 
            border-color: var(--r); 
            background: linear-gradient(135deg, rgba(40,0,0,0.95) 0%, rgba(60,10,10,0.9) 100%);
            animation: breaking-pulse 0.5s ease-in-out infinite;
        }
        .lt-container.lt-breaking .lt-title { color: #fff; }
        .lt-container.lt-breaking .lt-subtitle { color: var(--r); }
        
        @keyframes breaking-pulse {
            0%, 100% { box-shadow: 0 0 40px rgba(255,50,50,0.3); border-color: var(--r); }
            50% { box-shadow: 0 0 100px rgba(255,255,255,0.8); border-color: #fff; }
        }

        /* ═══════════════════════════════════════════════════════════════
           STATION BUG - HTML OVERLAY (Sharp)
           ═══════════════════════════════════════════════════════════════ */
        #station-bug {
            position: absolute;
            top: 30px; left: 30px;
            z-index: 2600;
            font-family: 'Orbitron', sans-serif;
            font-size: 28px; font-weight: 800;
            color: rgba(255,255,255,0.7);
            text-shadow: 0 0 20px var(--accent), 0 0 40px var(--accent-dim);
            backdrop-filter: blur(5px);
            padding: 5px 10px;
            cursor: move;
            user-select: none;
            transition: opacity 0.3s;
            pointer-events: auto;
        }
        
        #station-bug.hidden { opacity: 0; pointer-events: none; }
        
        #station-bug img {
            max-height: 60px;
            filter: drop-shadow(0 0 10px var(--accent));
        }

        /* ═══════════════════════════════════════════════════════════════
           TOP BAR
           ═══════════════════════════════════════════════════════════════ */
        #top-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 45px;
            background: linear-gradient(180deg, var(--panel-light) 0%, var(--panel) 100%);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 5000;
        }
        
        #brand { display: flex; align-items: center; }
        #status-bar { display: flex; align-items: center; gap: 15px; }
        
        .stat { display: flex; align-items: center; gap: 5px; font-size: 10px; }
        .dot { width: 7px; height: 7px; border-radius: 50%; background: var(--g); box-shadow: 0 0 6px var(--g); }
        .dot.live { background: var(--r); box-shadow: 0 0 8px var(--r); animation: dot-pulse 0.5s infinite; }
        @keyframes dot-pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        #clock { font-family: 'Orbitron', sans-serif; font-size: 16px; color: var(--accent); letter-spacing: 2px; }
        
        #tally { display: none; padding: 4px 12px; background: var(--r); color: #fff; font-size: 10px; font-weight: bold; letter-spacing: 2px; animation: tally-blink 1s infinite; }
        @keyframes tally-blink { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        .badge {
            display: flex; align-items: center; gap: 5px;
            padding: 3px 8px; border: 1px solid; font-size: 9px;
            cursor: pointer; transition: all 0.2s;
        }
        .badge:hover { box-shadow: 0 0 10px currentColor; }
        #fps-badge { border-color: var(--g); color: var(--g); background: rgba(0,255,136,0.05); }
        #cycle-badge { border-color: var(--y); color: var(--y); background: rgba(255,204,0,0.05); display: none; }
        #cycle-badge.on { display: flex; }

        /* ═══════════════════════════════════════════════════════════════
           SIDEBARS
           ═══════════════════════════════════════════════════════════════ */
        .sidebar {
            position: fixed; top: 45px; bottom: 55px; width: 200px;
            background: var(--panel);
            border: 1px solid var(--border);
            overflow-y: auto; z-index: 4000;
            scrollbar-width: none; /* Hide Firefox scrollbar */
            transition: border-color 0.4s ease, box-shadow 0.4s ease;
        }
        
        .sidebar::-webkit-scrollbar { display: none; } /* Hide Chrome scrollbar */
        
        /* NEON TRACE: Right panel gets left edge, Left panel gets right edge */
        #left-panel { 
            left: 0; border-left: none; 
            border-right: 1px solid rgba(0, 243, 255, 0.1);
        }
        #left-panel:hover {
            border-right: 1px solid var(--accent);
            box-shadow: inset -5px 0 15px var(--accent-dim);
        }
        
        #right-panel { 
            right: 0; border-right: none; 
            border-left: 1px solid rgba(0, 243, 255, 0.1);
        }
        #right-panel:hover {
            border-left: 1px solid var(--accent);
            box-shadow: inset 5px 0 15px var(--accent-dim);
        }
        
        .section { border-bottom: 1px solid var(--border); }
        
        .sec-head {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--border);
        }
        
        .sec-title { font-family: 'Orbitron', sans-serif; font-size: 9px; font-weight: 600; letter-spacing: 2px; color: var(--accent); }
        .sec-dot { width: 5px; height: 5px; background: var(--g); border-radius: 50%; box-shadow: 0 0 4px var(--g); }
        .sec-dot.off { background: var(--text-dim); box-shadow: none; }
        
        .sec-body { padding: 10px 12px; }
        
        /* Buttons */
        .btn {
            display: block; width: 100%;
            padding: 8px 10px; margin-bottom: 6px;
            background: linear-gradient(180deg, #0f0f14 0%, #0a0a0e 100%);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            text-align: left;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .btn:hover { background: linear-gradient(180deg, #151520 0%, #0f0f14 100%); color: var(--text-bright); border-color: var(--border-light); }
        .btn:active { box-shadow: inset 0 2px 10px rgba(0,0,0,0.8); transform: translateY(2px); }
        .btn.on { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 10px var(--accent-dim); }
        
        /* PARTY MODE Button - Magenta Breathing */
        #btn-ui-react {
            animation: party-breathe 3s ease-in-out infinite;
        }
        #btn-ui-react.on {
            animation: none;
            color: #ff00ff;
            text-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff;
            border-color: #ff00ff;
            background: rgba(255,0,255,0.1);
        }
        @keyframes party-breathe {
            0%, 100% { color: var(--text); text-shadow: none; }
            50% { color: #ff00ff; text-shadow: 0 0 8px #ff00ff; }
        }
        
        /* SEISMIC ENGINE Button - Orange/Fire */
        #btn-rumble {
            animation: seismic-breathe 2.5s ease-in-out infinite;
        }
        #btn-rumble.on {
            animation: none;
            color: #ff6600;
            text-shadow: 0 0 10px #ff6600, 0 0 20px #ff3300;
            border-color: #ff6600;
            background: rgba(255,102,0,0.1);
        }
        @keyframes seismic-breathe {
            0%, 100% { color: var(--text); text-shadow: none; }
            50% { color: #ff6600; text-shadow: 0 0 6px #ff6600; }
        }
        
        .btn.rec { background: linear-gradient(180deg, #1a0808 0%, #0f0505 100%); border-color: rgba(255,51,51,0.4); color: var(--r); }
        .btn.danger { border-color: var(--r); color: var(--r); }
        .btn.danger:hover { background: var(--r); color: #000; box-shadow: 0 0 20px var(--r); }
        
        /* Command Center - Glowing Action Buttons */
        #btn-master-reset {
            border-color: var(--y);
            color: var(--y);
            text-shadow: 0 0 6px rgba(255,204,0,0.5);
        }
        #btn-master-reset:hover {
            background: var(--y);
            color: #000;
            text-shadow: none;
            box-shadow: 0 0 20px var(--y);
        }
        #btn-purge {
            text-shadow: 0 0 6px rgba(255,50,50,0.5);
        }
        .btn.impact { background: linear-gradient(180deg, #1a1000 0%, #0f0800 100%); border-color: var(--o); color: var(--o); }
        
        .btn-row { display: flex; gap: 6px; }
        .btn-row .btn { flex: 1; text-align: center; }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .btn-grid .btn { text-align: center; }
        
        .btn-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; }
        .btn-grid-3 .btn { text-align: center; font-size: 9px; padding: 6px 4px; }
        
        /* Inputs */
        .inp {
            width: 100%; padding: 7px 10px; margin-bottom: 6px;
            background: #040406;
            border: 1px solid var(--border);
            color: var(--text-bright);
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
        }
        
        .inp:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 8px var(--accent-dim); }
        
        .lbl { font-size: 9px; color: var(--text-dim); letter-spacing: 1px; margin-bottom: 4px; text-transform: uppercase; }

        /* Sliders */
        .slider-wrap { margin-bottom: 10px; }
        .slider-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .slider-lbl { font-size: 9px; color: var(--text-dim); }
        .slider-val { font-size: 10px; color: var(--accent); font-family: 'Orbitron', sans-serif; }
        
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%; height: 4px;
            background: var(--border);
            border-radius: 2px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px; height: 14px;
            background: var(--accent);
            border-radius: 2px;
            box-shadow: 0 0 8px var(--accent-dim);
            cursor: pointer;
        }

        /* Camera Preview */
        #cam-preview {
            background: linear-gradient(135deg, #0a0a12 0%, #050510 100%);
            border: 2px solid var(--border);
            border-radius: 4px;
            width: calc(100% - 8px); height: 100px;
            margin: 4px auto 12px auto;
            overflow: hidden;
            position: relative;
        }
        
        #cam-preview::before {
            content: '';
            position: absolute;
            inset: 0;
            border: 2px solid transparent;
            border-image: linear-gradient(135deg, var(--c), var(--p), var(--g)) 1;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0.6;
        }
        
        #cam-preview video { width: 100%; height: 100%; object-fit: cover; }
        
        .preview-label {
            position: absolute;
            bottom: 4px; left: 4px;
            font-size: 8px; color: var(--accent);
            background: rgba(0,0,0,0.8);
            padding: 2px 6px;
            border-left: 2px solid var(--accent);
            letter-spacing: 1px;
        }
        
        .rec-indicator { position: absolute; top: 4px; right: 4px; width: 8px; height: 8px; background: var(--r); border-radius: 50%; display: none; animation: rec-blink 1s infinite; }
        .rec-indicator.on { display: block; }
        @keyframes rec-blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* Audio VU */
        #audio-box {
            background: #000;
            border: 1px solid var(--border);
            padding: 8px; margin-bottom: 8px;
            border-radius: 3px;
        }
        
        #vu { display: flex; gap: 2px; height: 30px; align-items: flex-end; }
        .vu-bar { flex: 1; background: linear-gradient(to top, var(--g) 0%, var(--y) 60%, var(--r) 90%); min-height: 2px; border-radius: 1px; transition: height 0.05s; }
        
        #track-info { font-family: 'Orbitron', sans-serif; font-size: 9px; color: var(--y); margin-top: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Palette */
        .palette-grid { display: flex; gap: 6px; flex-wrap: wrap; }
        .pal {
            width: 26px; height: 26px;
            border: 2px solid var(--border);
            cursor: pointer; border-radius: 4px;
            transition: all 0.2s;
        }
        .pal:hover { transform: scale(1.15); }
        .pal.on { border-color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.4); }
        
        .pal[data-t="cyan"] { background: #00f3ff; }
        .pal[data-t="magenta"] { background: #ff0055; }
        .pal[data-t="green"] { background: #00ff88; }
        .pal[data-t="purple"] { background: #b000ff; }
        .pal[data-t="gold"] { background: #ffd700; }
        .pal[data-t="night"] { background: linear-gradient(135deg, #0a0a15, #1a1a2a); border-color: #334455; }

        /* ═══════════════════════════════════════════════════════════════
           BOTTOM BAR
           ═══════════════════════════════════════════════════════════════ */
        #bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: 55px;
            background: linear-gradient(0deg, var(--panel-light) 0%, var(--panel) 100%);
            border-top: 1px solid var(--border);
            z-index: 5000;
            display: flex; flex-direction: column;
        }
        
        #ticker-wrap {
            flex: 1;
            display: flex; align-items: center;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--border);
            overflow: hidden;
        }
        
        #ticker-label { padding: 0 12px; font-size: 8px; letter-spacing: 2px; color: var(--accent); background: var(--accent-dim); height: 100%; display: flex; align-items: center; border-right: 1px solid var(--border); }
        #ticker-scroll { flex: 1; overflow: hidden; white-space: nowrap; }
        #ticker-text { display: inline-block; padding-left: 100%; animation: scroll-ticker 60s linear infinite; font-size: 10px; }
        @keyframes scroll-ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        
        #info-bar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 6px 15px; font-size: 9px;
        }
        
        .info-group { display: flex; gap: 20px; }
        .info-item { color: var(--text-dim); }
        .info-item span { color: var(--text); }
        .info-item .hl { color: var(--accent); }

        /* Sys Log */
        #sys-log {
            position: fixed; bottom: 55px; right: 200px;
            width: 220px; height: 45px;
            background: rgba(0,0,0,0.95);
            border: 1px solid var(--border); border-bottom: none;
            font-size: 8px; color: var(--text-dim);
            overflow-y: auto; padding: 5px; z-index: 4400;
        }
        
        .log-line { margin-bottom: 2px; }
        .log-line .ts { color: var(--accent); margin-right: 5px; }

        /* Countdown */
        #countdown {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.95);
            display: none; align-items: center; justify-content: center;
            z-index: 5000;
        }
        
        #countdown-num {
            font-family: 'Orbitron', sans-serif;
            font-size: 140px; font-weight: 900;
            color: var(--accent);
            text-shadow: 0 0 60px var(--accent);
        }

        /* Hidden inputs */
        /* Boot Screen - BIOS Terminal */
        /* MATERIAL BLUR REVEAL */
        .blur-reveal {
            position: fixed; inset: 0;
            backdrop-filter: blur(50px);
            -webkit-backdrop-filter: blur(50px);
            z-index: 99999;
            pointer-events: none;
            animation: material-reveal 0.5s ease forwards;
        }
        
        @keyframes material-reveal {
            0% { backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px); opacity: 1; }
            100% { backdrop-filter: blur(0px); -webkit-backdrop-filter: blur(0px); opacity: 0; }
        }

        input[type="file"] { display: none; }
        
        /* Progress bar */
        .prog { width: 100%; height: 3px; background: var(--border); margin-top: 5px; display: none; border-radius: 2px; }
        .prog-fill { height: 100%; width: 0%; background: var(--g); border-radius: 2px; transition: width 0.1s; }

        /* VHS/CRT */
        body.vhs #stage::before { background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.15) 2px, rgba(0,0,0,0.15) 4px); animation: vhs-track 0.1s steps(3) infinite; opacity: 0.6; }
        @keyframes vhs-track { 0% { background-position: 0 0; } 100% { background-position: 0 4px; } }
        body.crt #stage::after { background: radial-gradient(ellipse at center, transparent 30%, rgba(0,0,0,0.6) 100%); }
    </style>
</head>
<body>
    <!-- SVG Filter: Chromatic Ghost (GPU-accelerated RGB split) -->
    <svg style="position:absolute;width:0;height:0;">
        <defs>
            <filter id="chromatic-ghost" x="-20%" y="-20%" width="140%" height="140%">
                <feColorMatrix in="SourceGraphic" type="matrix" values="1 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 0" result="red"/>
                <feColorMatrix in="SourceGraphic" type="matrix" values="0 0 0 0 0  0 1 0 0 0  0 0 0 0 0  0 0 0 1 0" result="green"/>
                <feColorMatrix in="SourceGraphic" type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 1 0 0  0 0 0 1 0" result="blue"/>
                <feOffset in="red" dx="-15" dy="0" result="red-shift"/>
                <feOffset in="blue" dx="15" dy="0" result="blue-shift"/>
                <feBlend in="red-shift" in2="green" mode="screen" result="rg"/>
                <feBlend in="rg" in2="blue-shift" mode="screen"/>
            </filter>
        </defs>
    </svg>
    
    <!-- MATERIAL BLUR REVEAL -->
    <div class="blur-reveal" id="blur-reveal"></div>
    
    <!-- TOP BAR -->
    <header id="top-bar">
        <div id="brand">
            <span class="logo m1" id="main-logo">DRIS<span style="font-size:14px;font-weight:400;color:var(--accent);opacity:0.6;margin-left:2px;letter-spacing:1px">//&nbsp;core</span></span>
            <span class="sub-tag">VNGRD</span>
            <span class="version">v22.1</span>
        </div>
        
        <div id="status-bar">
            <div class="badge" id="fps-badge">FPS: <span id="fps-val">60</span></div>
            <div class="badge" id="cycle-badge">CYCLE</div>
            <div class="stat"><div class="dot" id="main-dot"></div><span id="status-text">STANDBY</span></div>
            <div id="tally">ON AIR</div>
            <div id="clock">00:00:00</div>
        </div>
    </header>

    <!-- STAGE -->
    <main id="stage">
        <canvas id="vj-canvas"></canvas>
        
        <!-- HTML OVERLAY LAYER (Sharp Typography) -->
        <div id="overlay-layer">
            <!-- Station Bug -->
            <div id="station-bug">DRIS//core</div>
            
            <!-- Lower Third -->
            <div id="lower-third">
                <div class="lt-container lt-guest">
                    <div class="lt-title" id="lt-title-text">GUEST NAME</div>
                    <div class="lt-subtitle" id="lt-subtitle-text">TITLE / ROLE</div>
                </div>
            </div>
        </div>
        
        <div id="countdown"><div id="countdown-num">3</div></div>
    </main>

    <!-- LEFT PANEL -->
    <aside class="sidebar" id="left-panel">
        <!-- CAMERA -->
        <div class="section">
            <div class="sec-head">
                <span class="sec-title">CAMERA</span>
                <div class="sec-dot off" id="cam-dot"></div>
            </div>
            <div class="sec-body">
                <div id="cam-preview" style="display:none;">
                    <video id="preview-vid" autoplay muted playsinline></video>
                    <div class="preview-label">PREVIEW</div>
                    <div class="rec-indicator" id="rec-dot"></div>
                </div>
                <button class="btn" id="btn-init-cam">SENSORS ONLINE</button>
                <div id="cam-ctrls" style="display:none">
                    <button class="btn" id="btn-go-live" style="color:var(--y)">GO LIVE [3-2-1]</button>
                    <div class="btn-row">
                        <button class="btn" id="btn-clip">CLIP 10s</button>
                        <button class="btn" id="btn-mic">MIC</button>
                    </div>
                </div>
                <div id="live-ctrls" style="display:none">
                    <button class="btn rec" id="btn-rec">● REC</button>
                    <button class="btn" id="btn-end">END LIVE</button>
                </div>
                <button class="btn" id="btn-kill" style="display:none;color:var(--r)">SHUTDOWN CAM</button>
            </div>
        </div>
        
        <!-- MEDIA DECK -->
        <div class="section">
            <div class="sec-head">
                <span class="sec-title">MEDIA DECK</span>
                <div class="sec-dot off" id="media-dot"></div>
            </div>
            <div class="sec-body">
                <button class="btn" id="btn-media" style="display:flex;justify-content:space-between; margin-bottom:4px;">
                    <span>+ IMPORT MEDIA</span>
                    <span style="opacity:0.5; font-size:9px;">Q: <span id="q-count">0</span></span>
                </button>
                
                <div style="display:flex; gap:4px;">
                    <button class="btn" id="btn-prev" style="width:30px;">&lt;</button>
                    <button class="btn" id="btn-cycle" style="flex:1; color:var(--y); border-color:var(--border);">CYCLE: OFF</button>
                    <input type="number" id="cycle-time" value="8" min="1" max="60" style="width:36px; background:#000; border:1px solid var(--border); color:var(--accent); text-align:center; font-family:'JetBrains Mono', monospace; font-size:11px;" title="Image Secs">
                    <button class="btn" id="btn-rotate" style="width:30px;">&gt;</button>
                </div>
            </div>
        </div>
        
        <!-- COMMAND CENTER -->
        <div class="section">
            <div class="sec-head">
                <span class="sec-title">COMMAND</span>
                <div class="sec-dot"></div>
            </div>
            <div class="sec-body" style="padding-top:12px;">
                <div class="btn-row" style="margin-bottom:8px;">
                    <button class="btn" id="btn-ui-react">PARTY MODE</button>
                    <button class="btn" id="btn-rumble">SEISMIC</button>
                </div>
                <button class="btn" id="btn-eject">EJECT CURRENT</button>
                <button class="btn" id="btn-master-reset">[ESC] MASTER RESET</button>
                <button class="btn danger" id="btn-purge">PURGE ALL</button>
            </div>
        </div>
        
        <!-- LOWER THIRDS -->
        <div class="section">
            <div class="sec-head">
                <span class="sec-title">LOWER THIRD</span>
                <div class="sec-dot"></div>
            </div>
            <div class="sec-body">
                <input type="text" class="inp" id="lt-title" placeholder="Title..." value="GUEST NAME">
                <input type="text" class="inp" id="lt-sub" placeholder="Subtitle..." value="TITLE / ROLE">
                <div class="btn-grid">
                    <button class="btn" id="btn-lt-guest">GUEST</button>
                    <button class="btn" id="btn-lt-track">TRACK</button>
                    <button class="btn" id="btn-lt-breaking">BREAKING</button>
                    <button class="btn" id="btn-lt-off">OFF</button>
                </div>
            </div>
        </div>
        
        <!-- STATION BUG -->
        <div class="section">
            <div class="sec-head">
                <span class="sec-title">STATION BUG</span>
                <div class="sec-dot"></div>
            </div>
            <div class="sec-body">
                <div class="btn-row">
                    <button class="btn" id="btn-upload-logo">UPLOAD LOGO</button>
                    <button class="btn" id="btn-clear-logo">CLEAR</button>
                </div>
                <input type="text" class="inp" id="bug-text" placeholder="Station name..." value="DRIS//core">
                <button class="btn" id="btn-bug-toggle">[B] SHOW/HIDE</button>
            </div>
        </div>
    </aside>

    <!-- RIGHT PANEL -->
    <aside class="sidebar" id="right-panel">
        <!-- AUDIO -->
        <div class="section">
            <div class="sec-head">
                <span class="sec-title">AUDIO</span>
                <div class="sec-dot off" id="audio-dot"></div>
            </div>
            <div class="sec-body">
                <div id="audio-box">
                    <div id="vu"></div>
                    <div id="track-info">NO TRACK</div>
                </div>
                <button class="btn" id="btn-audio">LOAD AUDIO</button>
                <div class="btn-row">
                    <button class="btn" id="btn-next-track">NEXT</button>
                    <button class="btn" id="btn-stop">STOP</button>
                </div>
                <div class="lbl" style="margin-top:8px;">SPATIAL MODE</div>
                <div class="btn-grid-3">
                    <button class="btn on" id="btn-stereo">STEREO</button>
                    <button class="btn" id="btn-spatial">3D</button>
                    <button class="btn" id="btn-dolby">DOLBY</button>
                </div>
                <div class="lbl" style="margin-top:8px;">OUTPUT DEVICE</div>
                <select class="inp" id="audio-output" style="cursor:pointer;">
                    <option value="">Default</option>
                </select>
            </div>
        </div>
        
        <!-- IMPACT FX -->
        <div class="section">
            <div class="sec-head">
                <span class="sec-title">IMPACT FX</span>
                <div class="sec-dot"></div>
            </div>
            <div class="sec-body">
                <div class="btn-grid-3">
                    <button class="btn impact" id="btn-stutter">STUTTER</button>
                    <button class="btn impact" id="btn-invert">INVERT</button>
                    <button class="btn impact" id="btn-crush">CRUSH</button>
                </div>
            </div>
        </div>
        
        <!-- VJ ENGINE -->
        <div class="section">
            <div class="sec-head">
                <span class="sec-title">VJ ENGINE</span>
                <div class="sec-dot"></div>
            </div>
            <div class="sec-body">
                <div class="slider-wrap">
                    <div class="slider-top"><span class="slider-lbl">BRIGHTNESS</span><span class="slider-val" id="val-b">100%</span></div>
                    <input type="range" min="30" max="170" value="100" id="sl-b">
                </div>
                <div class="slider-wrap">
                    <div class="slider-top"><span class="slider-lbl">CONTRAST</span><span class="slider-val" id="val-c">100%</span></div>
                    <input type="range" min="30" max="170" value="100" id="sl-c">
                </div>
                <div class="slider-wrap">
                    <div class="slider-top"><span class="slider-lbl">SATURATION</span><span class="slider-val" id="val-s">100%</span></div>
                    <input type="range" min="0" max="200" value="100" id="sl-s">
                </div>
                <div class="slider-wrap">
                    <div class="slider-top"><span class="slider-lbl">HUE</span><span class="slider-val" id="val-h">0°</span></div>
                    <input type="range" min="0" max="360" value="0" id="sl-h">
                </div>
            </div>
        </div>
        
        <!-- CANVAS FX -->
        <div class="section">
            <div class="sec-head">
                <span class="sec-title">CANVAS FX</span>
                <div class="sec-dot"></div>
            </div>
            <div class="sec-body">
                <div class="btn-row">
                    <button class="btn" id="btn-trails">TRAILS</button>
                    <button class="btn" id="btn-rgb">RGB</button>
                </div>
                <div class="slider-wrap">
                    <div class="slider-top"><span class="slider-lbl">TRAIL α</span><span class="slider-val" id="val-trail">0.92</span></div>
                    <input type="range" min="50" max="98" value="92" id="sl-trail">
                </div>
                <div class="slider-wrap">
                    <div class="slider-top"><span class="slider-lbl">RGB SHIFT</span><span class="slider-val" id="val-rgb">0</span></div>
                    <input type="range" min="0" max="30" value="0" id="sl-rgb">
                </div>
                <div class="btn-row">
                    <button class="btn" id="btn-pixelate">PIXEL</button>
                    <button class="btn" id="btn-bass-link">BASS→RGB</button>
                </div>
                <div class="slider-wrap">
                    <div class="slider-top"><span class="slider-lbl">PIXEL SIZE</span><span class="slider-val" id="val-pix">1</span></div>
                    <input type="range" min="1" max="32" value="1" id="sl-pix">
                </div>
            </div>
        </div>
        
        <!-- OVERLAYS -->
        <div class="section">
            <div class="sec-head">
                <span class="sec-title">OVERLAYS</span>
                <div class="sec-dot"></div>
            </div>
            <div class="sec-body">
                <div class="btn-grid">
                    <button class="btn" id="btn-vhs">VHS</button>
                    <button class="btn" id="btn-crt">CRT</button>
                    <button class="btn" id="btn-reset">RESET FX</button>
                    <button class="btn" id="btn-fs">[H] FULL</button>
                </div>
            </div>
        </div>
        
        <!-- THEME -->
        <div class="section">
            <div class="sec-head">
                <span class="sec-title">THEME</span>
                <div class="sec-dot"></div>
            </div>
            <div class="sec-body">
                <div class="palette-grid">
                    <div class="pal on" data-t="cyan"></div>
                    <div class="pal" data-t="magenta"></div>
                    <div class="pal" data-t="green"></div>
                    <div class="pal" data-t="purple"></div>
                    <div class="pal" data-t="gold"></div>
                    <div class="pal" data-t="night"></div>
                </div>
            </div>
        </div>
        
        <!-- SESSION -->
        <div class="section">
            <div class="sec-head">
                <span class="sec-title">SESSION</span>
                <div class="sec-dot"></div>
            </div>
            <div class="sec-body">
                <div class="btn-row">
                    <button class="btn" id="btn-save">SAVE</button>
                    <button class="btn" id="btn-load">LOAD</button>
                </div>
                <button class="btn" id="btn-export-dna">EXPORT .VGD</button>
                <button class="btn" id="btn-projector">PROJECTOR (Clean Feed)</button>
                <button class="btn" id="btn-capture30">CAPTURE 30s</button>
                <button class="btn" id="btn-enter-vr">ENTER VR</button>
            </div>
        </div>
        
        <!-- P2P GUEST -->
        <div class="section">
            <div class="sec-head">
                <span class="sec-title">P2P GUEST</span>
                <div class="sec-dot" id="guest-dot"></div>
            </div>
            <div class="sec-body">
                <input type="text" class="inp" id="peer-id-display" readonly placeholder="Your ID...">
                <input type="text" class="inp" id="remote-peer-id" placeholder="Remote ID...">
                <div class="btn-row">
                    <button class="btn" id="btn-init-peer">INIT PEER</button>
                    <button class="btn" id="btn-connect-guest">CONNECT</button>
                </div>
                <button class="btn" id="btn-disconnect-guest">DISCONNECT</button>
            </div>
        </div>
    </aside>

    <!-- BOTTOM BAR -->
    <footer id="bottom-bar">
        <div id="ticker-wrap">
            <div id="ticker-label">SYS</div>
            <div id="ticker-scroll">
                <div id="ticker-text">DRIS//core VNGRD v22.1 // HYBRID BROADCAST // [H] FULLSCREEN [SPACE] NEXT [B] BUG [ESC] RESET // IMPACT FX: STUTTER • INVERT • CRUSH // <span id="ticker-crypto">BTC $--- | ETH $--- | SOL $---</span></div>
            </div>
        </div>
        <div id="info-bar">
            <div class="info-group">
                <div class="info-item">UP: <span id="uptime" class="hl">00:00:00</span></div>
                <div class="info-item">RES: <span id="res">1920x1080</span></div>
                <div class="info-item">Q: <span id="q-info">0</span></div>
            </div>
            <div class="info-group">
                <div class="info-item">MODE: <span id="render-mode" class="hl">HYBRID</span></div>
            </div>
        </div>
    </footer>

    <!-- SYS LOG -->
    <div id="sys-log"></div>

    <!-- HIDDEN -->
    <input type="file" id="file-media" multiple accept="image/*,video/*">
    <input type="file" id="file-audio" multiple accept="audio/*">
    <input type="file" id="file-logo" accept="image/*">
    <audio id="audio-el"></audio>
    <div id="media-container" style="display:none;"></div>

<script>
// ═══════════════════════════════════════════════════════════════════════════
// DRIS//core VNGRD v22.1 — HYBRID BROADCAST MONSTER
// ═══════════════════════════════════════════════════════════════════════════

const $ = id => document.getElementById(id);

// ═══════════════════════════════════════════════════════════════════════════
// MASTER APP OBJECT
// ═══════════════════════════════════════════════════════════════════════════
const APP = {
    state: {
        isLive: false,
        isRecording: false,
        isFullscreen: false,
        isCycle: false,
        cycleTimer: null,
        isMobile: false,
        theme: 'cyan',
        startTime: Date.now(),
        lastPrices: { btc: 0, eth: 0, sol: 0 }
    },

    vj: {
        brightness: 1.0,
        contrast: 1.0,
        saturation: 1.0,
        hue: 0,
        trailsEnabled: false,
        trailAlpha: 0.92,
        rgbEnabled: false,
        rgbIntensity: 0,
        rgbBassLink: false,
        pixelateEnabled: false,
        pixelSize: 1,
        rumbleEnabled: false,
        invert: false,
        uiReactivity: false,
        seismicTimer: null,
        shakeIntensity: 0,
        lastBassLevel: 0
    },

    // Stored VJ state for impact recovery
    vjSnapshot: null,

    media: {
        queue: [],
        currentIndex: -1,
        currentElement: null,
        isTransitioning: false
    },

    audio: {
        ctx: null,
        analyzer: null,
        source: null,
        element: null,
        playlist: [],
        currentTrack: -1,
        currentTrackName: '',
        bassLevel: 0,
        vuData: new Uint8Array(32),
        isPlaying: false,
        isConnected: false,
        // Spatial Audio & Broadcast Chain
        spatialMode: 'stereo', // 'stereo', '3d', 'dolby'
        spatialEnabled: false,
        panner: null,
        compressor: null,
        masterGain: null,
        listener: null
    },

    // Projector (Clean Feed)
    projector: {
        window: null,
        stream: null,
        isOpen: false
    },

    // Time Machine (Rolling Buffer)
    timeMachine: {
        recorder: null,
        chunks: [],
        stream: null,
        audioDest: null,
        isRecording: false,
        maxDuration: 30000 // 30 seconds
    },

    // WebXR
    xr: {
        supported: false,
        checked: false,
        session: null,
        refSpace: null,
        gl: null,
        vjTexture: null,
        shaderProgram: null,
        quadBuffer: null,
        // Shader locations
        aPosition: null,
        aTexCoord: null,
        uProjection: null,
        uView: null,
        uTexture: null
    },

    // WebRTC Guest Module (PeerJS)
    guest: {
        peer: null,
        connection: null,
        stream: null,
        videoElement: null,
        audioSource: null,
        isActive: false,
        peerId: null
    },

    // Sovereign Security Module
    security: {
        purge: null // Function assigned at runtime
    },

    camera: {
        stream: null,
        recorder: null,
        chunks: [],
        mode: 'off',
        isRecording: false,
        isClipping: false
    },

    render: {
        canvas: null,
        ctx: null,
        width: 1920,
        height: 1080,
        fps: 0,
        frameCount: 0,
        lastTime: 0,
        lastFpsUpdate: 0,
        rafId: null,
        scale: 1.0
    },

    bug: {
        visible: true,
        text: 'DRIS//core',
        image: null
    },

    lowerThird: {
        visible: false,
        preset: 'guest',
        title: 'GUEST NAME',
        subtitle: 'TITLE / ROLE'
    },

    ui: {
        logoMorph: 0,
        morphs: ['m1','m2','m3','m4','m5','m6','m7','m8','m9','m10','m11','m12','m13','m14','m15']
    }
};

// ═══════════════════════════════════════════════════════════════════════════
// UTILITIES
// ═══════════════════════════════════════════════════════════════════════════
function log(msg) {
    const box = $('sys-log');
    const ts = new Date().toTimeString().split(' ')[0];
    const el = document.createElement('div');
    el.className = 'log-line';
    el.innerHTML = `<span class="ts">${ts}</span>${msg}`;
    box.insertBefore(el, box.firstChild);
    if (box.children.length > 30) box.lastChild.remove();
}

function checkMobile() {
    APP.state.isMobile = /Android|iPhone|iPad|iPod|webOS|BlackBerry/i.test(navigator.userAgent);
    if (APP.state.isMobile) {
        APP.render.width = 960;
        APP.render.height = 540;
        log('MOBILE_MODE');
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// CANVAS INITIALIZATION
// ═══════════════════════════════════════════════════════════════════════════
function initCanvas() {
    APP.render.canvas = $('vj-canvas');
    APP.render.ctx = APP.render.canvas.getContext('2d', { alpha: false, desynchronized: true });
    
    resizeCanvas();
    window.addEventListener('resize', () => {
        resizeCanvas();
        checkMobile();
    });
    log('CANVAS_INIT');
}

function resizeCanvas() {
    APP.render.canvas.width = APP.render.width;
    APP.render.canvas.height = APP.render.height;
    $('res').textContent = `${APP.render.width}x${APP.render.height}`;
}

// ═══════════════════════════════════════════════════════════════════════════
// 60FPS RENDER LOOP
// ═══════════════════════════════════════════════════════════════════════════
function renderLoop(timestamp) {
    APP.render.rafId = requestAnimationFrame(renderLoop);
    
    // FPS
    APP.render.frameCount++;
    if (timestamp - APP.render.lastFpsUpdate >= 1000) {
        APP.render.fps = APP.render.frameCount;
        APP.render.frameCount = 0;
        APP.render.lastFpsUpdate = timestamp;
        $('fps-val').textContent = APP.render.fps;
    }
    
    const ctx = APP.render.ctx;
    const w = APP.render.width;
    const h = APP.render.height;
    
    // Precision Rendering - crisp pixels, no blur
    ctx.imageSmoothingEnabled = false;
    
    // RUMBLE SCALE (Bass-linked)
    if (APP.vj.rumbleEnabled && APP.audio.bassLevel > 100) {
        APP.render.scale = 1.0 + (APP.audio.bassLevel / 255) * 0.06;
    } else {
        APP.render.scale = 1.0;
    }
    
    // TRAILS
    if (APP.vj.trailsEnabled) {
        ctx.globalAlpha = APP.vj.trailAlpha;
        ctx.save();
        ctx.translate(w / 2, h / 2);
        ctx.scale(1.008, 1.008);
        ctx.translate(-w / 2, -h / 2);
        ctx.drawImage(APP.render.canvas, 0, 0);
        ctx.restore();
        ctx.globalAlpha = 1;
    } else {
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, w, h);
    }
    
    // DRAW SOURCE (Priority: Guest > Live Camera > Media Queue)
    let source = null;
    let forceFullBleed = false;
    
    if (APP.guest.stream && APP.guest.isActive) {
        // Guest stream takes priority - create video element if needed
        if (!APP.guest.videoElement) {
            APP.guest.videoElement = document.createElement('video');
            APP.guest.videoElement.srcObject = APP.guest.stream;
            APP.guest.videoElement.muted = true;
            APP.guest.videoElement.playsInline = true;
            APP.guest.videoElement.play().catch(() => {});
        }
        source = APP.guest.videoElement;
        forceFullBleed = true; // Guest always full-bleed
    } else if (APP.state.isLive && APP.camera.stream) {
        source = $('preview-vid');
    } else if (APP.media.currentElement) {
        source = APP.media.currentElement;
    }
    
    if (source) {
        const ready = source.tagName === 'VIDEO' ? source.readyState >= 2 : source.complete;
        if (ready) {
            // VJ filter
            ctx.filter = `brightness(${APP.vj.brightness}) contrast(${APP.vj.contrast}) saturate(${APP.vj.saturation}) hue-rotate(${APP.vj.hue}deg)${APP.vj.invert ? ' invert(1)' : ''}`;
            
            // ADAPTIVE SCALING: Full-bleed in fullscreen or guest, safe area in windowed
            const srcW = source.videoWidth || source.naturalWidth || source.width;
            const srcH = source.videoHeight || source.naturalHeight || source.height;
            
            let scale, drawW, drawH, drawX, drawY;
            
            if (APP.state.isFullscreen || forceFullBleed) {
                // FULL-BLEED: Cover entire screen (may crop)
                scale = Math.max(w / srcW, h / srcH) * APP.render.scale;
                drawW = srcW * scale;
                drawH = srcH * scale;
                drawX = (w - drawW) / 2;
                drawY = (h - drawH) / 2;
            } else {
                // SOVEREIGN SAFE AREA: Contain with 5% margin
                const safeW = w * 0.9;
                const safeH = h * 0.9;
                scale = Math.min(safeW / srcW, safeH / srcH) * APP.render.scale;
                drawW = srcW * scale;
                drawH = srcH * scale;
                drawX = (w - drawW) / 2;
                drawY = (h - drawH) / 2;
            }
            
            ctx.drawImage(source, drawX, drawY, drawW, drawH);
            ctx.filter = 'none';
        }
    }
    
    // GPU PIXELATE ENGINE (Fixed-size offscreen canvas)
    if (APP.vj.pixelateEnabled && APP.vj.pixelSize > 1) {
        // Create fixed 64x36 downscale canvas once (16:9 @ 64px wide)
        if (!APP.render.pixelCanvas) {
            APP.render.pixelCanvas = document.createElement('canvas');
            APP.render.pixelCanvas.width = 64;
            APP.render.pixelCanvas.height = 36;
            APP.render.pixelCtx = APP.render.pixelCanvas.getContext('2d');
            APP.render.pixelCtx.imageSmoothingEnabled = false;
        }
        
        // Stage 1: Downsample to tiny canvas (GPU accelerated)
        const downScale = Math.max(1, Math.floor(APP.vj.pixelSize / 2));
        const tW = Math.floor(64 / downScale);
        const tH = Math.floor(36 / downScale);
        APP.render.pixelCtx.drawImage(APP.render.canvas, 0, 0, tW, tH);
        
        // Stage 2: Upsample back to full size (no smoothing = blocky pixels)
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(APP.render.pixelCanvas, 0, 0, tW, tH, 0, 0, w, h);
    }
    
    // RGB Shift: Apply via CSS filter (GPU-accelerated)
    if (APP.vj.rgbEnabled && APP.vj.rgbIntensity > 0) {
        let offset = APP.vj.rgbIntensity;
        if (APP.vj.rgbBassLink) offset = Math.floor((APP.audio.bassLevel / 255) * APP.vj.rgbIntensity * 2);
        if (offset > 0) {
            APP.render.canvas.style.filter = `url(#chromatic-ghost)`;
            APP.render.rgbActive = true;
        }
    } else if (APP.render.rgbActive) {
        APP.render.canvas.style.filter = 'none';
        APP.render.rgbActive = false;
    }
    
    APP.render.lastTime = timestamp;
}

// ═══════════════════════════════════════════════════════════════════════════
// IMPACT FX (Musical Performance)
// ═══════════════════════════════════════════════════════════════════════════
function triggerImpact() {
    // Remove and force reflow for rapid-fire triggers
    document.body.classList.remove('impact-flash');
    void document.body.offsetWidth; // Force reflow
    document.body.classList.add('impact-flash');
    setTimeout(() => document.body.classList.remove('impact-flash'), 200);
}

function triggerChromaticAberration() {
    // GPU-accelerated chromatic aberration via SVG filter
    const canvas = APP.render.canvas;
    canvas.style.filter = 'url(#chromatic-ghost)';
    
    setTimeout(() => {
        canvas.style.filter = 'none';
    }, 200);
}

function impactStutter() {
    // Snapshot current state
    const originalTrails = APP.vj.trailsEnabled;
    const originalAlpha = APP.vj.trailAlpha;
    
    APP.vj.trailsEnabled = true;
    APP.vj.trailAlpha = 0.98;
    
    // FX ISOLATION: Canvas-only effects
    triggerChromaticAberration();
    log('IMPACT: STUTTER');
    
    setTimeout(() => {
        APP.vj.trailsEnabled = originalTrails;
        APP.vj.trailAlpha = originalAlpha;
    }, 500);
}

function impactInvert() {
    APP.vj.invert = true;
    
    // FX ISOLATION: Canvas-only effects
    triggerChromaticAberration();
    log('IMPACT: INVERT');
    
    setTimeout(() => {
        APP.vj.invert = false;
    }, 500);
}

function impactCrush() {
    const originalRGB = APP.vj.rgbIntensity;
    const originalPix = APP.vj.pixelSize;
    const originalRGBEnabled = APP.vj.rgbEnabled;
    const originalPixEnabled = APP.vj.pixelateEnabled;
    
    APP.vj.rgbEnabled = true;
    APP.vj.pixelateEnabled = true;
    APP.vj.rgbIntensity = 25;
    APP.vj.pixelSize = 16;
    
    // FX ISOLATION: Canvas-only effects (RGB + Pixelate already on canvas)
    log('IMPACT: CRUSH');
    
    setTimeout(() => {
        APP.vj.rgbEnabled = originalRGBEnabled;
        APP.vj.pixelateEnabled = originalPixEnabled;
        APP.vj.rgbIntensity = originalRGB;
        APP.vj.pixelSize = originalPix;
    }, 500);
}

// ═══════════════════════════════════════════════════════════════════════════
// MEDIA SYSTEM
// ═══════════════════════════════════════════════════════════════════════════
function loadMediaFiles(input) {
    const isFirstLoad = APP.media.currentIndex === -1;
    
    Array.from(input.files).forEach((file, idx) => {
        const url = URL.createObjectURL(file);
        const type = file.type.startsWith('video') ? 'video' : 'image';
        const item = { type, url, element: null, name: file.name };
        
        if (type === 'video') {
            const vid = document.createElement('video');
            vid.src = url;
            vid.muted = true;
            vid.loop = !APP.state.isCycle; // Loop unless cycle active
            vid.playsInline = true;
            vid.preload = 'auto';
            item.element = vid;
            $('media-container').appendChild(vid);
        } else {
            const img = new Image();
            img.src = url;
            item.element = img;
        }
        
        APP.media.queue.push(item);
        
        // Immediately rotate on FIRST file added (no waiting)
        if (isFirstLoad && idx === 0) {
            rotateMedia();
        }
    });
    
    updateQueueDisplay();
    $('media-dot').classList.remove('off');
    
    log(`MEDIA: +${input.files.length}`);
    
    // Start cycle if active
    checkCycleLogic();
}

function rotateMedia() {
    if (APP.media.queue.length === 0) return;
    
    // INVERT SHIELD: Mask loading 'pop'
    APP.vj.invert = true;
    setTimeout(() => { APP.vj.invert = false; }, 50);
    
    // TRANSITION GLITCH: Chromatic aberration before swap
    triggerChromaticAberration();
    
    // TRANSITION FLASH: 100ms white flash
    const ctx = APP.render.ctx;
    const w = APP.render.width;
    const h = APP.render.height;
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, w, h);
    
    // Stop current
    if (APP.media.currentElement?.tagName === 'VIDEO') {
        APP.media.currentElement.pause();
    }
    
    APP.media.currentIndex = (APP.media.currentIndex + 1) % APP.media.queue.length;
    const item = APP.media.queue[APP.media.currentIndex];
    APP.media.currentElement = item.element;
    
    if (item.type === 'video') {
        item.element.loop = !APP.state.isCycle;
        item.element.currentTime = 0;
        item.element.play().catch(() => {});
    }
    
    // Trigger glitch on swap
    triggerImpact();
    log(`MEDIA: ${APP.media.currentIndex + 1}/${APP.media.queue.length}`);
    
    // Continue cycle if active
    checkCycleLogic();
}

function previousMedia() {
    if (APP.media.queue.length === 0) return;
    
    // INVERT SHIELD: Mask loading 'pop'
    APP.vj.invert = true;
    setTimeout(() => { APP.vj.invert = false; }, 50);
    
    // TRANSITION GLITCH: Chromatic aberration before swap
    triggerChromaticAberration();
    
    // TRANSITION FLASH: 100ms white flash
    const ctx = APP.render.ctx;
    const w = APP.render.width;
    const h = APP.render.height;
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, w, h);
    
    // Stop current
    if (APP.media.currentElement?.tagName === 'VIDEO') {
        APP.media.currentElement.pause();
    }
    
    // Go back (Index - 1), wrap around
    APP.media.currentIndex = (APP.media.currentIndex - 1 + APP.media.queue.length) % APP.media.queue.length;
    const item = APP.media.queue[APP.media.currentIndex];
    APP.media.currentElement = item.element;
    
    if (item.type === 'video') {
        item.element.loop = !APP.state.isCycle;
        item.element.currentTime = 0;
        item.element.play().catch(() => {});
    }
    
    triggerImpact();
    log(`MEDIA: ${APP.media.currentIndex + 1}/${APP.media.queue.length}`);
    
    // Continue cycle if active
    checkCycleLogic();
}

function ejectCurrent() {
    if (APP.media.queue.length === 0) return;
    
    const current = APP.media.queue[APP.media.currentIndex];
    
    // Stop and cleanup current media
    if (current.element?.tagName === 'VIDEO') {
        current.element.pause();
        current.element.src = '';
        current.element.remove();
    }
    URL.revokeObjectURL(current.url);
    
    // Splice out of queue
    APP.media.queue.splice(APP.media.currentIndex, 1);
    
    if (APP.media.queue.length === 0) {
        // Queue empty - reset to black stage
        APP.media.currentIndex = -1;
        APP.media.currentElement = null;
        $('media-dot').classList.add('off');
        
        // Clear canvas to black
        const ctx = APP.render.ctx;
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, APP.render.width, APP.render.height);
        log('QUEUE_EMPTY');
    } else {
        // Adjust index and play next
        if (APP.media.currentIndex >= APP.media.queue.length) {
            APP.media.currentIndex = 0;
        }
        const next = APP.media.queue[APP.media.currentIndex];
        APP.media.currentElement = next.element;
        
        if (next.type === 'video') {
            next.element.currentTime = 0;
            next.element.play().catch(() => {});
        }
        log(`PLAYING: ${APP.media.currentIndex + 1}/${APP.media.queue.length}`);
    }
    
    updateQueueDisplay();
    log('EJECTED');
}

function purgeAll() {
    // Delegate to Sovereign Security module for comprehensive wipe
    if (APP.security.purge) {
        APP.security.purge();
    } else {
        // Fallback: basic cleanup
        APP.media.queue.forEach(item => {
            if (item.element?.tagName === 'VIDEO') {
                item.element.pause();
                item.element.src = '';
                item.element.remove();
            }
            URL.revokeObjectURL(item.url);
        });
        APP.media.queue = [];
        APP.media.currentIndex = -1;
        APP.media.currentElement = null;
        $('media-dot').classList.add('off');
        
        APP.audio.playlist = [];
        APP.audio.currentTrack = -1;
        APP.audio.element.pause();
        APP.audio.element.src = '';
        APP.audio.isPlaying = false;
        $('audio-dot').classList.add('off');
        $('track-info').textContent = 'NO TRACK';
        
        updateQueueDisplay();
        log('PURGE_ALL');
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// SMART CYCLE ENGINE (Unified Media Rotation)
// ═══════════════════════════════════════════════════════════════════════════
function toggleCycle() {
    APP.state.isCycle = !APP.state.isCycle;
    const btn = $('btn-cycle');
    
    if (APP.state.isCycle) {
        btn.textContent = 'ON';
        btn.classList.add('on');
        btn.style.borderColor = 'var(--y)';
        $('cycle-badge').classList.add('on');
        checkCycleLogic(); // Start immediately
    } else {
        btn.textContent = 'CYCLE: OFF';
        btn.classList.remove('on');
        btn.style.borderColor = 'var(--border)';
        $('cycle-badge').classList.remove('on');
        clearTimeout(APP.state.cycleTimer);
        // Reset video looping
        if (APP.media.currentElement?.tagName === 'VIDEO') {
            APP.media.currentElement.loop = true;
        }
    }
    log(APP.state.isCycle ? 'CYCLE_ACTIVE' : 'CYCLE_STOP');
}

// ROUTER (Handles Video vs Image logic)
function checkCycleLogic() {
    clearTimeout(APP.state.cycleTimer);
    if (!APP.state.isCycle || APP.media.currentIndex === -1) return;

    const current = APP.media.queue[APP.media.currentIndex];
    if (!current) return;

    if (current.type === 'video') {
        // VIDEO: Play full length, then auto-next
        if (current.element) {
            current.element.loop = false;
            current.element.onended = () => {
                if (APP.state.isCycle) rotateMedia();
            };
        }
    } else {
        // IMAGE: Use the input value for duration
        const secs = parseInt($('cycle-time').value) || 8;
        APP.state.cycleTimer = setTimeout(() => {
            if (APP.state.isCycle) rotateMedia();
        }, secs * 1000);
    }
}

function updateQueueDisplay() {
    $('q-count').textContent = APP.media.queue.length;
}

// ═══════════════════════════════════════════════════════════════════════════
// LOWER THIRDS
// ═══════════════════════════════════════════════════════════════════════════
function showLowerThird(preset) {
    const lt = $('lower-third');
    const container = lt.querySelector('.lt-container');
    
    container.classList.remove('lt-guest', 'lt-track', 'lt-breaking');
    container.classList.add(`lt-${preset}`);
    
    APP.lowerThird.preset = preset;
    APP.lowerThird.visible = true;
    
    // Update content based on preset
    if (preset === 'track' && APP.audio.currentTrackName) {
        $('lt-title-text').textContent = APP.audio.currentTrackName;
        $('lt-subtitle-text').textContent = 'NOW PLAYING';
    } else if (preset === 'breaking') {
        $('lt-title-text').textContent = $('lt-title').value || 'BREAKING NEWS';
        $('lt-subtitle-text').textContent = $('lt-sub').value || 'LIVE UPDATE';
    } else {
        $('lt-title-text').textContent = $('lt-title').value || 'GUEST NAME';
        $('lt-subtitle-text').textContent = $('lt-sub').value || 'TITLE / ROLE';
    }
    
    lt.classList.add('visible');
    
    // Update button states
    ['guest', 'track', 'breaking', 'off'].forEach(p => {
        $(`btn-lt-${p}`).classList.toggle('on', p === preset);
    });
    
    log(`LT: ${preset.toUpperCase()}`);
}

function hideLowerThird() {
    $('lower-third').classList.remove('visible');
    APP.lowerThird.visible = false;
    ['guest', 'track', 'breaking', 'off'].forEach(p => {
        $(`btn-lt-${p}`).classList.remove('on');
    });
    $('btn-lt-off').classList.add('on');
    log('LT: OFF');
}

// ═══════════════════════════════════════════════════════════════════════════
// STATION BUG
// ═══════════════════════════════════════════════════════════════════════════
function updateBug() {
    const bug = $('station-bug');
    if (APP.bug.image) {
        bug.innerHTML = `<img src="${APP.bug.image}" alt="Logo">`;
    } else {
        // Use input value if available, else stored text, else default
        const inputVal = $('bug-text')?.value;
        bug.textContent = inputVal || APP.bug.text || 'DRIS//core';
    }
}

function toggleBug() {
    APP.bug.visible = !APP.bug.visible;
    $('station-bug').classList.toggle('hidden', !APP.bug.visible);
    $('btn-bug-toggle').classList.toggle('on', APP.bug.visible);
    log(APP.bug.visible ? 'BUG_ON' : 'BUG_OFF');
}

function loadLogoFile(input) {
    if (!input.files.length) return;
    APP.bug.image = URL.createObjectURL(input.files[0]);
    updateBug();
    log('LOGO_UPLOADED');
}

// Bug drag variables (initialized in DOMContentLoaded)
let bugDragging = false, bugOffsetX = 0, bugOffsetY = 0;

// ═══════════════════════════════════════════════════════════════════════════
// CAMERA SYSTEM
// ═══════════════════════════════════════════════════════════════════════════
async function initCamera() {
    try {
        APP.camera.stream = await navigator.mediaDevices.getUserMedia({
            video: { 
                width: { ideal: 1920, min: 1280 }, 
                height: { ideal: 1080, min: 720 },
                frameRate: { ideal: 60, min: 30 }
            },
            audio: false // Silent init - no mic popup
        });
        $('preview-vid').srcObject = APP.camera.stream;
        APP.camera.mode = 'preview';
        $('cam-preview').style.display = 'block';
        $('btn-init-cam').style.display = 'none';
        $('cam-ctrls').style.display = 'block';
        $('btn-kill').style.display = 'block';
        $('cam-dot').classList.remove('off');
        log('CAM_READY');
        
        // UNLOCK AUDIO: Initialize AudioContext on user gesture
        if (!APP.audio.ctx) {
            APP.audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
            log('AUDIO_CTX_UNLOCKED');
        }
        
        // ARM TIME MACHINE: User gesture required for MediaRecorder
        initTimeMachine();
        
        // Now enumerate audio outputs (permission already granted)
        enumerateAudioOutputs();
    } catch (e) {
        log('CAM_ERROR');
    }
}

function goLive() {
    if (!APP.camera.stream) return;
    const overlay = $('countdown');
    const num = $('countdown-num');
    overlay.style.display = 'flex';
    let count = 3;
    num.textContent = count;
    sovereignStrobe(); // Strobe on 3
    const interval = setInterval(() => {
        count--;
        if (count > 0) {
            num.textContent = count;
            sovereignStrobe(); // Strobe on 2, 1
        } else {
            clearInterval(interval);
            overlay.style.display = 'none';
            APP.state.isLive = true;
            APP.camera.mode = 'live';
            $('cam-ctrls').style.display = 'none';
            $('live-ctrls').style.display = 'block';
            $('tally').style.display = 'block';
            $('status-text').textContent = 'LIVE';
            $('main-dot').classList.add('live');
            document.querySelector('.preview-label').textContent = 'LIVE';
            sovereignStrobe(); // Final strobe on LIVE
            log('LIVE');
        }
    }, 1000);
}

function endLive() {
    if (APP.camera.isRecording) toggleRec();
    APP.state.isLive = false;
    APP.camera.mode = 'preview';
    $('live-ctrls').style.display = 'none';
    $('cam-ctrls').style.display = 'block';
    $('tally').style.display = 'none';
    $('status-text').textContent = 'STANDBY';
    $('main-dot').classList.remove('live');
    document.querySelector('.preview-label').textContent = 'PREVIEW';
    log('END_LIVE');
}

function toggleRec() {
    if (APP.camera.isRecording) {
        APP.camera.recorder.stop();
        $('tally').textContent = 'ON AIR';
        $('status-text').textContent = 'LIVE';
        document.querySelector('.preview-label').textContent = 'LIVE';
    } else {
        APP.camera.chunks = [];
        APP.camera.recorder = new MediaRecorder(APP.camera.stream);
        APP.camera.recorder.ondataavailable = e => APP.camera.chunks.push(e.data);
        APP.camera.recorder.onstop = () => {
            const blob = new Blob(APP.camera.chunks, { type: 'video/webm' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `DRIS_${Date.now()}.webm`;
            a.click();
            APP.camera.isRecording = false;
            $('btn-rec').textContent = '● REC';
            $('btn-rec').classList.remove('on');
            $('rec-dot').classList.remove('on');
            document.querySelector('.preview-label').textContent = 'LIVE';
            log('REC_SAVED');
        };
        APP.camera.recorder.start();
        APP.camera.isRecording = true;
        $('btn-rec').textContent = '■ STOP';
        $('btn-rec').classList.add('on');
        $('rec-dot').classList.add('on');
        $('tally').textContent = 'REC LIVE';
        $('status-text').textContent = 'RECORDING';
        document.querySelector('.preview-label').textContent = 'REC';
        log('REC_START');
    }
}

function toggleMic() {
    if (!APP.camera.stream) return;
    const track = APP.camera.stream.getAudioTracks()[0];
    if (track) {
        track.enabled = !track.enabled;
        $('btn-mic').classList.toggle('on', track.enabled);
        log(`MIC_${track.enabled ? 'ON' : 'OFF'}`);
    }
}

function clip10s() {
    if (!APP.camera.stream || APP.camera.isClipping) return;
    APP.camera.isClipping = true;
    let remaining = 10;
    $('btn-clip').textContent = `${remaining}s`;
    $('btn-clip').classList.add('on');
    
    const chunks = [];
    const rec = new MediaRecorder(APP.camera.stream);
    rec.ondataavailable = e => chunks.push(e.data);
    rec.onstop = () => {
        const vid = document.createElement('video');
        vid.src = URL.createObjectURL(new Blob(chunks, { type: 'video/webm' }));
        vid.muted = true;
        vid.playsInline = true;
        APP.media.queue.push({ type: 'video', url: vid.src, element: vid });
        $('media-container').appendChild(vid);
        updateQueueDisplay();
        $('btn-clip').textContent = 'CLIP 10s';
        $('btn-clip').classList.remove('on');
        APP.camera.isClipping = false;
        log('CLIP_OK');
    };
    rec.start();
    const countdown = setInterval(() => {
        remaining--;
        if (remaining > 0) $('btn-clip').textContent = `${remaining}s`;
        else { clearInterval(countdown); rec.stop(); }
    }, 1000);
}

function killCamera() {
    if (APP.camera.stream) APP.camera.stream.getTracks().forEach(t => t.stop());
    APP.camera.mode = 'off';
    APP.state.isLive = false;
    $('cam-preview').style.display = 'none';
    $('live-ctrls').style.display = 'none';
    $('cam-ctrls').style.display = 'none';
    $('btn-init-cam').style.display = 'block';
    $('btn-kill').style.display = 'none';
    $('cam-dot').classList.add('off');
    $('tally').style.display = 'none';
    $('status-text').textContent = 'STANDBY';
    $('main-dot').classList.remove('live');
    log('CAM_OFF');
}

// ═══════════════════════════════════════════════════════════════════════════
// AUDIO SYSTEM
// ═══════════════════════════════════════════════════════════════════════════
APP.audio.element = $('audio-el');

function loadAudioFiles(input) {
    Array.from(input.files).forEach(file => {
        APP.audio.playlist.push({
            url: URL.createObjectURL(file),
            name: file.name.replace(/\.[^.]+$/, '')
        });
    });
    $('audio-dot').classList.remove('off');
    if (!APP.audio.isPlaying && APP.audio.playlist.length) playTrack();
    log(`AUDIO: +${input.files.length}`);
}

function playTrack() {
    if (!APP.audio.playlist.length) return;
    if (!APP.audio.ctx) APP.audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
    
    APP.audio.currentTrack = (APP.audio.currentTrack + 1) % APP.audio.playlist.length;
    const track = APP.audio.playlist[APP.audio.currentTrack];
    APP.audio.currentTrackName = track.name;
    
    APP.audio.element.src = track.url;
    APP.audio.element.play().then(() => {
        APP.audio.isPlaying = true;
        $('track-info').textContent = track.name.toUpperCase();
        
        // Auto-update lower third if showing track
        if (APP.lowerThird.visible && APP.lowerThird.preset === 'track') {
            $('lt-title-text').textContent = track.name;
        }
        
        log(`PLAY: ${track.name}`);
    });
    
    if (!APP.audio.isConnected) setupAudioAnalyzer();
}

// ═══════════════════════════════════════════════════════════════════════════
// PRO-GRADE SPATIAL AUDIO ENGINE (DOLBY SIMULATION)
// ═══════════════════════════════════════════════════════════════════════════
function setupAudioAnalyzer() {
    try {
        if (!APP.audio.ctx) APP.audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
        
        // 1. Create the Nodes
        APP.audio.source = APP.audio.ctx.createMediaElementSource(APP.audio.element);
        APP.audio.analyzer = APP.audio.ctx.createAnalyser();
        APP.audio.panner = APP.audio.ctx.createPanner();
        APP.audio.compressor = APP.audio.ctx.createDynamicsCompressor();
        APP.audio.masterGain = APP.audio.ctx.createGain();
        
        // 2. Configure the Panner (HRTF is the Pro Standard)
        APP.audio.panner.panningModel = 'HRTF';
        APP.audio.panner.distanceModel = 'inverse';
        APP.audio.panner.refDistance = 1;
        
        // 3. Configure the Broadcast Limiter (The "Dolby" Glue)
        APP.audio.compressor.threshold.setValueAtTime(-18, APP.audio.ctx.currentTime);
        APP.audio.compressor.knee.setValueAtTime(30, APP.audio.ctx.currentTime);
        APP.audio.compressor.ratio.setValueAtTime(12, APP.audio.ctx.currentTime);
        APP.audio.compressor.attack.setValueAtTime(0.003, APP.audio.ctx.currentTime);
        APP.audio.compressor.release.setValueAtTime(0.25, APP.audio.ctx.currentTime);
        
        // 4. Configure Visuals & Headroom
        APP.audio.analyzer.fftSize = 64;
        APP.audio.masterGain.gain.setValueAtTime(0.9, APP.audio.ctx.currentTime);
        
        // 5. THE SERIAL CHAIN (Top-Tier Routing)
        // Source -> Panner -> Compressor -> Gain -> Analyzer -> Destination
        APP.audio.source
            .connect(APP.audio.panner)
            .connect(APP.audio.compressor)
            .connect(APP.audio.masterGain)
            .connect(APP.audio.analyzer)
            .connect(APP.audio.ctx.destination);
        
        APP.audio.vuData = new Uint8Array(APP.audio.analyzer.frequencyBinCount);
        APP.audio.isConnected = true;
        
        // Default position: in front of listener (stereo feel)
        positionAudio(0, 0, -1);
        
        // UI Update
        const vu = $('vu');
        vu.innerHTML = '';
        for (let i = 0; i < 16; i++) {
            const bar = document.createElement('div');
            bar.className = 'vu-bar';
            vu.appendChild(bar);
        }
        
        updateVU();
        log('DAW_ENGINE_ACTIVE');
    } catch (e) { log('AUDIO_CHAIN_ERR: ' + e.message); }
}

function updateVU() {
    requestAnimationFrame(updateVU);
    if (!APP.audio.analyzer || !APP.audio.isPlaying) return;
    
    APP.audio.analyzer.getByteFrequencyData(APP.audio.vuData);
    const bars = $('vu').children;
    for (let i = 0; i < bars.length; i++) {
        bars[i].style.height = Math.max(2, (APP.audio.vuData[i * 2] / 255) * 28) + 'px';
    }
    
    const currentBass = (APP.audio.vuData[0] + APP.audio.vuData[1] + APP.audio.vuData[2]) / 3;
    const bassDelta = currentBass - APP.vj.lastBassLevel;
    APP.audio.bassLevel = currentBass;
    
    // RHYTHMIC SEISMIC ENGINE (Peak Detection)
    if (APP.vj.rumbleEnabled) {
        // Detect bass 'hit' - significant upward spike
        if (bassDelta > 40 && currentBass > 150) {
            APP.vj.shakeIntensity = Math.min(1, currentBass / 200);
        }
        
        // Apply decaying shake with translate3d (GPU optimized)
        if (APP.vj.shakeIntensity > 0.05) {
            const x = (Math.random() - 0.5) * 20 * APP.vj.shakeIntensity;
            const y = (Math.random() - 0.5) * 15 * APP.vj.shakeIntensity;
            const r = (Math.random() - 0.5) * 4 * APP.vj.shakeIntensity;
            document.body.style.transform = `translate3d(${x}px, ${y}px, 0) rotate(${r}deg)`;
            
            // Decay for smooth physical 'thump' feel
            APP.vj.shakeIntensity *= 0.88;
        } else {
            APP.vj.shakeIntensity = 0;
            document.body.style.transform = 'translate3d(0, 0, 0) rotate(0)';
        }
    }
    
    // Store for next frame delta
    APP.vj.lastBassLevel = currentBass;
    
    // PARTY MODE: Shock Light & Skin Swap (No border glow - just flash effects)
    if (APP.vj.uiReactivity) {
        // Bass Hit Detection for Party Effects
        if (bassDelta > 40 && currentBass > 150) {
            // SHOCK LIGHT: Trigger logo-flash brightness effect
            document.body.classList.remove('logo-flash');
            void document.body.offsetWidth; // Force reflow
            document.body.classList.add('logo-flash');
            setTimeout(() => document.body.classList.remove('logo-flash'), 400);
            
            // SKIN SWAP: Strong hits trigger random theme
            if (bassDelta > 60 && currentBass > 180 && Math.random() > 0.6) {
                const themes = ['cyan', 'magenta', 'gold', 'purple', 'lime', 'orange'];
                const currentTheme = APP.state.theme;
                let newTheme = themes[Math.floor(Math.random() * themes.length)];
                // Ensure we actually change
                while (newTheme === currentTheme && themes.length > 1) {
                    newTheme = themes[Math.floor(Math.random() * themes.length)];
                }
                setTheme(newTheme);
            }
        }
    }
}

function stopAudio() {
    APP.audio.element.pause();
    APP.audio.element.currentTime = 0;
    APP.audio.isPlaying = false;
    $('track-info').textContent = 'NO TRACK';
    log('STOP');
}

// ═══════════════════════════════════════════════════════════════════════════
// AUDIO OUTPUT DEVICE SELECTION
// ═══════════════════════════════════════════════════════════════════════════
async function enumerateAudioOutputs() {
    try {
        // Silent enumeration - only show full labels if camera already initialized
        const devices = await navigator.mediaDevices.enumerateDevices();
        const outputs = devices.filter(d => d.kind === 'audiooutput');
        
        const select = $('audio-output');
        select.innerHTML = '<option value="">Default</option>';
        
        outputs.forEach((device, i) => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.textContent = device.label || `Output ${i + 1}`;
            select.appendChild(option);
        });
        
        log(`OUTPUTS: ${outputs.length}`);
    } catch (e) {
        log('OUTPUT_ENUM_ERR');
    }
}

async function setAudioOutput(deviceId) {
    if (!APP.audio.element.setSinkId) {
        log('SINKID_NOT_SUPPORTED');
        return;
    }
    
    try {
        await APP.audio.element.setSinkId(deviceId || '');
        
        // If we have an AudioContext with destination, we need to inform the user
        // that setSinkId only affects the HTMLAudioElement, not the Web Audio API destination
        // The entire chain (including spatial) flows through the element via MediaElementSource
        
        const label = deviceId ? 
            $('audio-output').options[$('audio-output').selectedIndex].text : 
            'Default';
        log(`OUTPUT: ${label}`);
    } catch (e) {
        log('OUTPUT_ERR: ' + e.message);
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// PROJECTOR MODE (Clean Feed)
// ═══════════════════════════════════════════════════════════════════════════
function openProjector() {
    if (APP.projector.isOpen && APP.projector.window && !APP.projector.window.closed) {
        APP.projector.window.focus();
        return;
    }
    
    // Capture canvas stream at 60fps
    APP.projector.stream = APP.render.canvas.captureStream(60);
    
    // Open clean window
    APP.projector.window = window.open('', 'DRIS_Projector', 
        'width=1280,height=720,menubar=no,toolbar=no,location=no,status=no');
    
    if (!APP.projector.window) {
        log('PROJECTOR_BLOCKED');
        return;
    }
    
    APP.projector.window.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>DRIS//core PROJECTOR</title>
            <style>
                * { margin: 0; padding: 0; }
                body { background: #000; overflow: hidden; }
                video { width: 100vw; height: 100vh; object-fit: contain; }
            </style>
        </head>
        <body>
            <video id="projector-feed" autoplay muted playsinline></video>
            <script>
                document.getElementById('projector-feed').srcObject = window.opener.APP.projector.stream;
            <\/script>
        </body>
        </html>
    `);
    
    APP.projector.isOpen = true;
    $('btn-projector').classList.add('on');
    
    // Monitor for close
    const checkClosed = setInterval(() => {
        if (APP.projector.window.closed) {
            clearInterval(checkClosed);
            APP.projector.isOpen = false;
            $('btn-projector').classList.remove('on');
            log('PROJECTOR_CLOSED');
        }
    }, 1000);
    
    log('PROJECTOR_OPEN');
}

// ═══════════════════════════════════════════════════════════════════════════
// SPATIAL AUDIO (3D HRTF)
// ═══════════════════════════════════════════════════════════════════════════
function setSpatialMode(mode) {
    if (!APP.audio.ctx || !APP.audio.panner) {
        log('LOAD_AUDIO_FIRST');
        return;
    }
    
    APP.audio.spatialMode = mode;
    
    // Update button states
    $('btn-stereo').classList.toggle('on', mode === 'stereo');
    $('btn-spatial').classList.toggle('on', mode === '3d');
    $('btn-dolby').classList.toggle('on', mode === 'dolby');
    
    const listener = APP.audio.ctx.listener;
    
    switch(mode) {
        case 'stereo':
            // Standard stereo - sound directly in front
            APP.audio.panner.panningModel = 'equalpower';
            positionAudio(0, 0, -1);
            log('MODE: STEREO');
            break;
            
        case '3d':
            // HRTF binaural 3D positioning
            APP.audio.panner.panningModel = 'HRTF';
            APP.audio.panner.distanceModel = 'inverse';
            APP.audio.panner.refDistance = 1;
            APP.audio.panner.maxDistance = 10000;
            APP.audio.panner.rolloffFactor = 1;
            
            // Position listener facing forward
            if (listener.forwardZ) {
                listener.positionX.value = 0;
                listener.positionY.value = 0;
                listener.positionZ.value = 0;
                listener.forwardX.value = 0;
                listener.forwardY.value = 0;
                listener.forwardZ.value = -1;
                listener.upX.value = 0;
                listener.upY.value = 1;
                listener.upZ.value = 0;
            }
            
            positionAudio(0, 0, -2);
            log('MODE: 3D_HRTF');
            break;
            
        case 'dolby':
            // Dolby Atmos simulation - wider soundstage, height cues
            APP.audio.panner.panningModel = 'HRTF';
            APP.audio.panner.distanceModel = 'linear';
            APP.audio.panner.refDistance = 1;
            APP.audio.panner.maxDistance = 100;
            APP.audio.panner.rolloffFactor = 0.5;
            
            // Dolby-style: wider cone for immersive feel
            APP.audio.panner.coneInnerAngle = 360;
            APP.audio.panner.coneOuterAngle = 360;
            APP.audio.panner.coneOuterGain = 1;
            
            // Simulate Atmos "dome" - sound from above and around
            if (listener.forwardZ) {
                listener.positionX.value = 0;
                listener.positionY.value = 0;
                listener.positionZ.value = 0;
                listener.forwardX.value = 0;
                listener.forwardY.value = 0;
                listener.forwardZ.value = -1;
                listener.upX.value = 0;
                listener.upY.value = 1;
                listener.upZ.value = 0;
            }
            
            // Position slightly above and in front (Atmos height channel feel)
            positionAudio(0, 1, -3);
            
            // Boost compressor for Dolby loudness profile
            if (APP.audio.compressor) {
                APP.audio.compressor.threshold.setValueAtTime(-18, APP.audio.ctx.currentTime);
                APP.audio.compressor.ratio.setValueAtTime(8, APP.audio.ctx.currentTime);
            }
            
            log('MODE: DOLBY_ATMOS');
            break;
    }
}

// Legacy toggle function for backward compat
function toggleSpatialAudio() {
    if (APP.audio.spatialMode === '3d') {
        setSpatialMode('stereo');
    } else {
        setSpatialMode('3d');
    }
}

// Position audio in 3D space (x: left/right, y: up/down, z: front/back)
function positionAudio(x, y, z) {
    if (!APP.audio.panner || !APP.audio.spatialEnabled) return;
    
    if (APP.audio.panner.positionX) {
        APP.audio.panner.positionX.setValueAtTime(x, APP.audio.ctx.currentTime);
        APP.audio.panner.positionY.setValueAtTime(y, APP.audio.ctx.currentTime);
        APP.audio.panner.positionZ.setValueAtTime(z, APP.audio.ctx.currentTime);
    } else {
        APP.audio.panner.setPosition(x, y, z);
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// TIME MACHINE (Rolling 30s Buffer - Pro-Audio Tap)
// ═══════════════════════════════════════════════════════════════════════════
function initTimeMachine() {
    // Create canvas stream at 60fps
    const canvasStream = APP.render.canvas.captureStream(60);
    
    // PRO-AUDIO TAP: Connect directly from masterGain (post Spatial/Dolby/Compressor)
    if (APP.audio.ctx && APP.audio.masterGain) {
        try {
            APP.timeMachine.audioDest = APP.audio.ctx.createMediaStreamDestination();
            APP.audio.masterGain.connect(APP.timeMachine.audioDest);
            
            // Add the processed audio track to canvas stream
            const audioTrack = APP.timeMachine.audioDest.stream.getAudioTracks()[0];
            if (audioTrack) {
                canvasStream.addTrack(audioTrack);
                log('TIMEMACHINE: SPATIAL_AUDIO_LINKED');
            }
        } catch (e) {
            log('TIMEMACHINE: VIDEO_ONLY');
        }
    }
    
    APP.timeMachine.stream = canvasStream;
    
    // CODEC ENFORCEMENT: VP9 video + Opus audio at 8Mbps
    const options = { 
        mimeType: 'video/webm;codecs=vp9,opus', 
        videoBitsPerSecond: 8000000,
        audioBitsPerSecond: 128000
    };
    
    try {
        APP.timeMachine.recorder = new MediaRecorder(canvasStream, options);
    } catch (e) {
        // Fallback if opus not supported
        try {
            APP.timeMachine.recorder = new MediaRecorder(canvasStream, { 
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 8000000 
            });
        } catch (e2) {
            APP.timeMachine.recorder = new MediaRecorder(canvasStream);
        }
    }
    
    APP.timeMachine.chunks = [];
    
    APP.timeMachine.recorder.ondataavailable = (e) => {
        if (e.data.size > 0) {
            APP.timeMachine.chunks.push({ data: e.data, time: Date.now() });
            
            // Prune chunks older than 30s
            const cutoff = Date.now() - APP.timeMachine.maxDuration;
            APP.timeMachine.chunks = APP.timeMachine.chunks.filter(c => c.time > cutoff);
        }
    };
    
    // Record in 1-second intervals for granular buffer
    APP.timeMachine.recorder.start(1000);
    APP.timeMachine.isRecording = true;
    
    log('TIMEMACHINE: ARMED_60FPS');
}

function capture30s() {
    if (!APP.timeMachine.isRecording || APP.timeMachine.chunks.length === 0) {
        // Initialize if not running
        initTimeMachine();
        $('btn-capture30').textContent = 'BUFFERING...';
        setTimeout(() => {
            $('btn-capture30').textContent = 'CAPTURE 30s';
            if (APP.timeMachine.chunks.length > 0) {
                downloadTimeMachine();
            } else {
                log('TIMEMACHINE: NO_DATA');
            }
        }, 2000);
        return;
    }
    
    downloadTimeMachine();
}

function downloadTimeMachine() {
    // VISUAL CONFIRMATION: 200ms white strobe
    sovereignStrobe();
    
    // Combine all chunks
    const blobs = APP.timeMachine.chunks.map(c => c.data);
    const finalBlob = new Blob(blobs, { type: 'video/webm' });
    
    // Download
    const a = document.createElement('a');
    a.href = URL.createObjectURL(finalBlob);
    a.download = `DRIS_TimeMachine_${Date.now()}.webm`;
    a.click();
    
    const duration = Math.round(APP.timeMachine.chunks.length);
    log(`TIMEMACHINE: CAPTURED_${duration}s`);
}

function sovereignStrobe() {
    // Quick white flash on canvas for visual confirmation
    const ctx = APP.render.ctx;
    const w = APP.render.width;
    const h = APP.render.height;
    
    // Store current composite operation
    const prevOp = ctx.globalCompositeOperation;
    
    // Flash white
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
    ctx.fillRect(0, 0, w, h);
    
    // Restore after 200ms (render loop will naturally overwrite)
    setTimeout(() => {
        ctx.globalCompositeOperation = prevOp;
    }, 200);
    
    triggerImpact();
}

// ═══════════════════════════════════════════════════════════════════════════
// WEBXR (VR/AR Support)
// ═══════════════════════════════════════════════════════════════════════════
async function initXR() {
    if (!navigator.xr) {
        APP.xr.supported = false;
        return;
    }
    
    try {
        APP.xr.supported = await navigator.xr.isSessionSupported('immersive-vr');
        if (APP.xr.supported) {
            $('btn-enter-vr').style.display = 'block';
            log('VR_AVAILABLE');
        }
    } catch (e) {
        APP.xr.supported = false;
    }
}

async function enterVR() {
    // Init XR on first click (avoids permission prompt at startup)
    if (!APP.xr.checked) {
        await initXR();
        APP.xr.checked = true;
    }
    
    if (!APP.xr.supported) {
        log('VR_NOT_SUPPORTED');
        return;
    }
    
    try {
        APP.xr.session = await navigator.xr.requestSession('immersive-vr', {
            requiredFeatures: ['local-floor']
        });
        
        APP.xr.session.addEventListener('end', () => {
            APP.xr.session = null;
            $('btn-enter-vr').classList.remove('on');
            log('VR_EXIT');
        });
        
        $('btn-enter-vr').classList.add('on');
        
        // Get reference space
        APP.xr.refSpace = await APP.xr.session.requestReferenceSpace('local-floor');
        
        // Create XR-compatible WebGL2 context
        const gl = APP.render.canvas.getContext('webgl2', { xrCompatible: true });
        APP.xr.gl = gl;
        
        if (gl) {
            const baseLayer = new XRWebGLLayer(APP.xr.session, gl);
            APP.xr.session.updateRenderState({ baseLayer });
            
            // Initialize VJ Texture for streaming canvas
            APP.xr.vjTexture = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, APP.xr.vjTexture);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
            
            // Create 16:9 quad vertices (3m back, eye level 1.6m)
            // Screen size: ~5.33m x 3m (cinema scale)
            const quadVerts = new Float32Array([
                // Position (x,y,z), TexCoord (u,v)
                -2.67, 3.1, -3,   0, 0,  // Top-left
                 2.67, 3.1, -3,   1, 0,  // Top-right
                -2.67, 0.1, -3,   0, 1,  // Bottom-left
                 2.67, 0.1, -3,   1, 1   // Bottom-right
            ]);
            
            APP.xr.quadBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, APP.xr.quadBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, quadVerts, gl.STATIC_DRAW);
            
            // SOVEREIGN SHADER: Vertex shader
            const vsSource = `
                attribute vec3 aPosition;
                attribute vec2 aTexCoord;
                uniform mat4 uProjection;
                uniform mat4 uView;
                varying vec2 vTexCoord;
                void main() {
                    gl_Position = uProjection * uView * vec4(aPosition, 1.0);
                    vTexCoord = aTexCoord;
                }
            `;
            
            // SOVEREIGN SHADER: Fragment shader
            const fsSource = `
                precision mediump float;
                uniform sampler2D uTexture;
                varying vec2 vTexCoord;
                void main() {
                    gl_FragColor = texture2D(uTexture, vTexCoord);
                }
            `;
            
            // Compile shaders
            const vs = gl.createShader(gl.VERTEX_SHADER);
            gl.shaderSource(vs, vsSource);
            gl.compileShader(vs);
            
            const fs = gl.createShader(gl.FRAGMENT_SHADER);
            gl.shaderSource(fs, fsSource);
            gl.compileShader(fs);
            
            // Link program
            APP.xr.shaderProgram = gl.createProgram();
            gl.attachShader(APP.xr.shaderProgram, vs);
            gl.attachShader(APP.xr.shaderProgram, fs);
            gl.linkProgram(APP.xr.shaderProgram);
            
            // Get attribute/uniform locations
            APP.xr.aPosition = gl.getAttribLocation(APP.xr.shaderProgram, 'aPosition');
            APP.xr.aTexCoord = gl.getAttribLocation(APP.xr.shaderProgram, 'aTexCoord');
            APP.xr.uProjection = gl.getUniformLocation(APP.xr.shaderProgram, 'uProjection');
            APP.xr.uView = gl.getUniformLocation(APP.xr.shaderProgram, 'uView');
            APP.xr.uTexture = gl.getUniformLocation(APP.xr.shaderProgram, 'uTexture');
            
            // Lock broadcast compressor for visor density
            if (APP.audio.compressor) {
                APP.audio.compressor.threshold.setValueAtTime(-18, APP.audio.ctx.currentTime);
            }
            
            // Position Dolby audio listener at eye level
            if (APP.audio.ctx && APP.audio.ctx.listener) {
                const listener = APP.audio.ctx.listener;
                if (listener.positionX) {
                    listener.positionX.value = 0;
                    listener.positionY.value = 1.6;
                    listener.positionZ.value = 0;
                }
            }
            
            // Start XR render loop
            APP.xr.session.requestAnimationFrame(xrRenderLoop);
            log('VR_WEBGL_BRIDGE_ACTIVE');
        }
        
        log('VR_ENTER');
    } catch (e) {
        log('VR_ERROR: ' + e.message);
    }
}

function xrRenderLoop(time, frame) {
    if (!APP.xr.session) return;
    
    APP.xr.session.requestAnimationFrame(xrRenderLoop);
    
    const pose = frame.getViewerPose(APP.xr.refSpace);
    if (!pose) return;
    
    const glLayer = APP.xr.session.renderState.baseLayer;
    const gl = APP.xr.gl;
    
    gl.bindFramebuffer(gl.FRAMEBUFFER, glLayer.framebuffer);
    gl.clearColor(0, 0, 0, 1);
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
    
    // Stream VJ canvas to texture
    if (APP.xr.vjTexture) {
        gl.bindTexture(gl.TEXTURE_2D, APP.xr.vjTexture);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, APP.render.canvas);
    }
    
    // Use Sovereign Shader
    gl.useProgram(APP.xr.shaderProgram);
    
    // Bind VJ texture to unit 0
    gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D, APP.xr.vjTexture);
    gl.uniform1i(APP.xr.uTexture, 0);
    
    // Setup vertex attributes
    gl.bindBuffer(gl.ARRAY_BUFFER, APP.xr.quadBuffer);
    
    // Position attribute (3 floats, stride 20 bytes, offset 0)
    gl.enableVertexAttribArray(APP.xr.aPosition);
    gl.vertexAttribPointer(APP.xr.aPosition, 3, gl.FLOAT, false, 20, 0);
    
    // TexCoord attribute (2 floats, stride 20 bytes, offset 12)
    gl.enableVertexAttribArray(APP.xr.aTexCoord);
    gl.vertexAttribPointer(APP.xr.aTexCoord, 2, gl.FLOAT, false, 20, 12);
    
    // Render floating cinema screen for each eye
    for (const view of pose.views) {
        const viewport = glLayer.getViewport(view);
        gl.viewport(viewport.x, viewport.y, viewport.width, viewport.height);
        
        // Set projection and view matrices from XR pose
        gl.uniformMatrix4fv(APP.xr.uProjection, false, view.projectionMatrix);
        gl.uniformMatrix4fv(APP.xr.uView, false, view.transform.inverse.matrix);
        
        // DRAW THE QUAD: 4 vertices as triangle strip
        gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
    }
    
    // Cleanup
    gl.disableVertexAttribArray(APP.xr.aPosition);
    gl.disableVertexAttribArray(APP.xr.aTexCoord);
}

// ═══════════════════════════════════════════════════════════════════════════
// MASTER RESET
// ═══════════════════════════════════════════════════════════════════════════
function masterReset() {
    document.body.classList.remove('vhs', 'crt');
    $('btn-vhs').classList.remove('on');
    $('btn-crt').classList.remove('on');
    
    APP.vj = {
        brightness: 1.0, contrast: 1.0, saturation: 1.0, hue: 0,
        trailsEnabled: false, trailAlpha: 0.92,
        rgbEnabled: false, rgbIntensity: 0, rgbBassLink: false,
        pixelateEnabled: false, pixelSize: 1,
        rumbleEnabled: false, invert: false, uiReactivity: true
    };
    
    $('sl-b').value = 100; $('val-b').textContent = '100%';
    $('sl-c').value = 100; $('val-c').textContent = '100%';
    $('sl-s').value = 100; $('val-s').textContent = '100%';
    $('sl-h').value = 0; $('val-h').textContent = '0°';
    $('sl-trail').value = 92; $('val-trail').textContent = '0.92';
    $('sl-rgb').value = 0; $('val-rgb').textContent = '0';
    $('sl-pix').value = 1; $('val-pix').textContent = '1';
    
    ['btn-trails', 'btn-rgb', 'btn-pixelate', 'btn-bass-link', 'btn-rumble', 'btn-ui-react'].forEach(id => $(id).classList.remove('on'));
    
    triggerImpact();
    log('MASTER_RESET');
}

// ═══════════════════════════════════════════════════════════════════════════
// UI CONTROLS
// ═══════════════════════════════════════════════════════════════════════════
function setTheme(theme) {
    document.body.className = document.body.className.replace(/theme-\w+/g, '');
    if (theme !== 'cyan') document.body.classList.add(`theme-${theme}`);
    APP.state.theme = theme;
    document.querySelectorAll('.pal').forEach(p => p.classList.toggle('on', p.dataset.t === theme));
    log(`THEME: ${theme}`);
}

function toggleVHS() { document.body.classList.toggle('vhs'); $('btn-vhs').classList.toggle('on'); log('VHS'); }
function toggleCRT() { document.body.classList.toggle('crt'); $('btn-crt').classList.toggle('on'); log('CRT'); }

function toggleFullscreen() {
    APP.state.isFullscreen = !APP.state.isFullscreen;
    document.body.classList.toggle('fullscreen', APP.state.isFullscreen);
    $('btn-fs').classList.toggle('on', APP.state.isFullscreen);
    log('FULLSCREEN');
}

function morphLogo() {
    const logo = $('main-logo');
    APP.ui.morphs.forEach(m => logo.classList.remove(m));
    APP.ui.logoMorph = (APP.ui.logoMorph + 1) % APP.ui.morphs.length;
    logo.classList.add(APP.ui.morphs[APP.ui.logoMorph]);
    setTimeout(morphLogo, 4000);
}

function updateClock() {
    $('clock').textContent = new Date().toTimeString().split(' ')[0];
    const s = Math.floor((Date.now() - APP.state.startTime) / 1000);
    $('uptime').textContent = `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
}

async function fetchCrypto() {
    try {
        const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana&vs_currencies=usd');
        const data = await res.json();
        const fmt = n => n >= 1000 ? (n/1000).toFixed(1) + 'K' : n.toFixed(0);
        
        // Track price direction
        const btc = data.bitcoin.usd;
        const eth = data.ethereum.usd;
        const sol = data.solana.usd;
        
        const btcDir = btc > APP.state.lastPrices.btc ? '▲' : btc < APP.state.lastPrices.btc ? '▼' : '';
        const ethDir = eth > APP.state.lastPrices.eth ? '▲' : eth < APP.state.lastPrices.eth ? '▼' : '';
        const solDir = sol > APP.state.lastPrices.sol ? '▲' : sol < APP.state.lastPrices.sol ? '▼' : '';
        
        const btcColor = btc >= APP.state.lastPrices.btc ? 'var(--g)' : 'var(--r)';
        const ethColor = eth >= APP.state.lastPrices.eth ? 'var(--g)' : 'var(--r)';
        const solColor = sol >= APP.state.lastPrices.sol ? 'var(--g)' : 'var(--r)';
        
        // Store for next comparison
        APP.state.lastPrices = { btc, eth, sol };
        
        // Build HTML with colored prices
        $('ticker-crypto').innerHTML = 
            `<span style="color:${btcColor}">BTC $${fmt(btc)}${btcDir}</span> | ` +
            `<span style="color:${ethColor}">ETH $${fmt(eth)}${ethDir}</span> | ` +
            `<span style="color:${solColor}">SOL $${fmt(sol)}${solDir}</span>`;
    } catch(e) {}
}

function saveSession() {
    localStorage.setItem('dris_v22', JSON.stringify({ theme: APP.state.theme, vj: APP.vj, bug: APP.bug }));
    log('SAVED');
}

function loadSession() {
    const data = JSON.parse(localStorage.getItem('dris_v22') || '{}');
    if (data.theme) setTheme(data.theme);
    if (data.vj) Object.assign(APP.vj, data.vj);
    if (data.bug) Object.assign(APP.bug, data.bug);
    updateBug();
    log('LOADED');
}

// ═══════════════════════════════════════════════════════════════════════════
// VGD DNA SERIALIZATION (.vgd Session Export)
// ═══════════════════════════════════════════════════════════════════════════
function exportDNA() {
    const dna = {
        version: 'VNGRD_22.1',
        timestamp: Date.now(),
        theme: APP.state.theme,
        vj: { ...APP.vj },
        bug: { ...APP.bug },
        media: APP.media.queue.map(item => ({
            name: item.name,
            type: item.type
        })),
        audio: {
            spatialMode: APP.audio.spatialMode,
            playlist: APP.audio.playlist.map(item => item.name || 'Unknown')
        },
        state: {
            isCycle: APP.state.isCycle
        }
    };
    
    const blob = new Blob([JSON.stringify(dna, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `SESSION_${Date.now()}.vgd`;
    a.click();
    URL.revokeObjectURL(a.href);
    
    log('DNA_EXPORTED');
    return dna;
}

// Assign to APP.state for API access
APP.state.exportDNA = exportDNA;

// ═══════════════════════════════════════════════════════════════════════════
// WEBRTC GUEST MODULE (PeerJS Bridge)
// ═══════════════════════════════════════════════════════════════════════════
function initGuest(peerId) {
    if (!window.Peer) {
        log('PEERJS_NOT_LOADED');
        $('peer-id-display').value = 'PeerJS not loaded';
        return;
    }
    
    APP.guest.peer = new Peer(peerId);
    
    APP.guest.peer.on('open', id => {
        APP.guest.peerId = id;
        $('peer-id-display').value = id;
        $('guest-dot').classList.add('on');
        log(`GUEST_PEER_ID: ${id}`);
    });
    
    APP.guest.peer.on('call', call => {
        // Answer incoming call with empty stream (receive-only)
        call.answer();
        
        call.on('stream', remoteStream => {
            APP.guest.stream = remoteStream;
            APP.guest.isActive = true;
            
            // Pipe remote audio into -18dB compressor chain
            if (APP.audio.ctx && APP.audio.compressor) {
                APP.guest.audioSource = APP.audio.ctx.createMediaStreamSource(remoteStream);
                APP.guest.audioSource.connect(APP.audio.compressor);
                log('GUEST_AUDIO_LINKED_18dB');
            }
            
            log('GUEST_STREAM_ACTIVE');
        });
        
        call.on('close', () => {
            disconnectGuest();
        });
    });
    
    APP.guest.peer.on('error', err => {
        $('peer-id-display').value = 'Error: ' + err.type;
        $('guest-dot').classList.remove('on');
        log('GUEST_ERROR: ' + err.type);
    });
}

function connectToGuest(remotePeerId) {
    if (!APP.guest.peer) {
        log('INIT_PEER_FIRST');
        return;
    }
    
    // Request remote stream
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(localStream => {
            const call = APP.guest.peer.call(remotePeerId, localStream);
            
            call.on('stream', remoteStream => {
                APP.guest.stream = remoteStream;
                APP.guest.isActive = true;
                
                // Pipe remote audio into -18dB compressor chain
                if (APP.audio.ctx && APP.audio.compressor) {
                    APP.guest.audioSource = APP.audio.ctx.createMediaStreamSource(remoteStream);
                    APP.guest.audioSource.connect(APP.audio.compressor);
                    log('GUEST_AUDIO_LINKED_18dB');
                }
                
                log('GUEST_CONNECTED');
            });
        })
        .catch(err => log('GUEST_MEDIA_ERR'));
}

function disconnectGuest() {
    if (APP.guest.stream) {
        APP.guest.stream.getTracks().forEach(t => t.stop());
        APP.guest.stream = null;
    }
    if (APP.guest.videoElement) {
        APP.guest.videoElement.srcObject = null;
        APP.guest.videoElement = null;
    }
    if (APP.guest.audioSource) {
        APP.guest.audioSource.disconnect();
        APP.guest.audioSource = null;
    }
    if (APP.guest.connection) {
        APP.guest.connection.close();
        APP.guest.connection = null;
    }
    APP.guest.isActive = false;
    log('GUEST_DISCONNECTED');
}

// Assign to APP.guest for API access
APP.guest.init = initGuest;
APP.guest.connect = connectToGuest;
APP.guest.disconnect = disconnectGuest;

// ═══════════════════════════════════════════════════════════════════════════
// SOVEREIGN SECURITY (The Wipe)
// ═══════════════════════════════════════════════════════════════════════════
function sovereignPurge() {
    // 1. Revoke all media URLs
    APP.media.queue.forEach(item => {
        if (item.url) URL.revokeObjectURL(item.url);
        if (item.element?.tagName === 'VIDEO') {
            item.element.pause();
            item.element.src = '';
            item.element.remove();
        }
    });
    APP.media.queue = [];
    APP.media.currentIndex = -1;
    APP.media.currentElement = null;
    
    // 2. Revoke audio playlist URLs
    APP.audio.playlist.forEach(item => {
        if (item.url) URL.revokeObjectURL(item.url);
    });
    APP.audio.playlist = [];
    if (APP.audio.element) {
        APP.audio.element.pause();
        APP.audio.element.src = '';
    }
    
    // 3. Stop guest stream
    disconnectGuest();
    if (APP.guest.peer) {
        APP.guest.peer.destroy();
        APP.guest.peer = null;
    }
    
    // 4. Stop camera
    if (APP.camera.stream) {
        APP.camera.stream.getTracks().forEach(t => t.stop());
        APP.camera.stream = null;
    }
    
    // 5. Stop time machine
    if (APP.timeMachine.recorder && APP.timeMachine.isRecording) {
        APP.timeMachine.recorder.stop();
        APP.timeMachine.isRecording = false;
    }
    APP.timeMachine.chunks = [];
    
    // 6. Delete IndexedDB databases
    if (indexedDB.databases) {
        indexedDB.databases().then(dbs => {
            dbs.forEach(db => indexedDB.deleteDatabase(db.name));
        });
    }
    
    // 7. Clear localStorage
    localStorage.removeItem('dris_v22');
    
    // 8. Reset UI
    updateQueueDisplay();
    $('media-dot').classList.add('off');
    $('track-info').textContent = 'NO TRACK';
    
    // Visual confirmation
    sovereignStrobe();
    log('SOVEREIGN_PURGE_COMPLETE');
}

// Assign to APP.security
APP.security.purge = sovereignPurge;

// ═══════════════════════════════════════════════════════════════════════════
// HARDWARE LOCK (Sovereign App Behavior)
// ═══════════════════════════════════════════════════════════════════════════
window.oncontextmenu = (e) => e.preventDefault();

// ═══════════════════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', () => {
    log('DRIS//core_VNGRD_v22.1');
    log('HYBRID_BROADCAST_MONSTER');
    
    checkMobile();
    initCanvas();
    
    APP.render.lastFpsUpdate = performance.now();
    requestAnimationFrame(renderLoop);
    
    updateClock();
    setInterval(updateClock, 1000);
    morphLogo();
    updateBug();
    
    // Logo click
    $('main-logo').onclick = () => {
        // ALWAYS trigger shock flash on logo click
        document.body.classList.remove('logo-flash');
        void document.body.offsetWidth; // Force reflow for rapid clicks
        document.body.classList.add('logo-flash');
        setTimeout(() => document.body.classList.remove('logo-flash'), 400);
        
        // Cycle logo morph style
        const logo = $('main-logo');
        APP.ui.morphs.forEach(m => logo.classList.remove(m));
        logo.classList.add(APP.ui.morphs[Math.floor(Math.random() * APP.ui.morphs.length)]);
    };
    
    // Camera
    $('btn-init-cam').onclick = initCamera;
    $('btn-go-live').onclick = goLive;
    $('btn-end').onclick = endLive;
    $('btn-rec').onclick = toggleRec;
    $('btn-mic').onclick = toggleMic;
    $('btn-clip').onclick = clip10s;
    $('btn-kill').onclick = killCamera;
    
    // Media
    $('btn-media').onclick = () => $('file-media').click();
    $('file-media').onchange = e => loadMediaFiles(e.target);
    $('btn-rotate').onclick = rotateMedia;
    $('btn-prev').onclick = previousMedia;
    $('btn-cycle').onclick = toggleCycle;
    
    // Command Center
    $('btn-eject').onclick = ejectCurrent;
    $('btn-master-reset').onclick = masterReset;
    $('btn-purge').onclick = () => { if (confirm('PURGE ALL media and audio?')) purgeAll(); };
    
    // Lower Thirds
    $('btn-lt-guest').onclick = () => showLowerThird('guest');
    $('btn-lt-track').onclick = () => showLowerThird('track');
    $('btn-lt-breaking').onclick = () => showLowerThird('breaking');
    $('btn-lt-off').onclick = hideLowerThird;
    $('lt-title').oninput = e => { if (APP.lowerThird.visible) $('lt-title-text').textContent = e.target.value; };
    $('lt-sub').oninput = e => { if (APP.lowerThird.visible) $('lt-subtitle-text').textContent = e.target.value; };
    
    // Station Bug
    $('btn-upload-logo').onclick = () => $('file-logo').click();
    $('btn-clear-logo').onclick = () => { 
        APP.bug.image = null; 
        APP.bug.text = 'DRIS//core';
        $('bug-text').value = 'DRIS//core';
        updateBug(); 
        log('LOGO_RESET'); 
    };
    $('file-logo').onchange = e => loadLogoFile(e.target);
    $('bug-text').oninput = e => { APP.bug.text = e.target.value; APP.bug.image = null; updateBug(); };
    $('btn-bug-toggle').onclick = toggleBug;
    
    // Station bug drag
    $('station-bug').addEventListener('mousedown', e => {
        bugDragging = true;
        bugOffsetX = e.offsetX;
        bugOffsetY = e.offsetY;
        $('station-bug').style.cursor = 'grabbing';
    });
    
    document.addEventListener('mousemove', e => {
        if (!bugDragging) return;
        const stage = $('stage').getBoundingClientRect();
        const x = e.clientX - stage.left - bugOffsetX;
        const y = e.clientY - stage.top - bugOffsetY;
        $('station-bug').style.left = Math.max(0, x) + 'px';
        $('station-bug').style.top = Math.max(0, y) + 'px';
    });
    
    document.addEventListener('mouseup', () => {
        if (bugDragging) {
            bugDragging = false;
            $('station-bug').style.cursor = 'move';
        }
    });
    
    // Audio
    $('btn-audio').onclick = () => { $('file-audio').click(); };
    $('file-audio').onchange = e => loadAudioFiles(e.target);
    $('btn-next-track').onclick = playTrack;
    $('btn-stop').onclick = stopAudio;
    
    // Impact FX
    $('btn-stutter').onclick = impactStutter;
    $('btn-invert').onclick = impactInvert;
    $('btn-crush').onclick = impactCrush;
    $('btn-rumble').onclick = () => { APP.vj.rumbleEnabled = !APP.vj.rumbleEnabled; $('btn-rumble').classList.toggle('on'); log('SEISMIC_' + (APP.vj.rumbleEnabled ? 'ON' : 'OFF')); };
    $('btn-ui-react').onclick = () => { APP.vj.uiReactivity = !APP.vj.uiReactivity; $('btn-ui-react').classList.toggle('on'); log('PARTY_MODE_' + (APP.vj.uiReactivity ? 'ON' : 'OFF')); };
    
    // VJ sliders
    $('sl-b').oninput = e => { APP.vj.brightness = e.target.value / 100; $('val-b').textContent = e.target.value + '%'; };
    $('sl-c').oninput = e => { APP.vj.contrast = e.target.value / 100; $('val-c').textContent = e.target.value + '%'; };
    $('sl-s').oninput = e => { APP.vj.saturation = e.target.value / 100; $('val-s').textContent = e.target.value + '%'; };
    $('sl-h').oninput = e => { APP.vj.hue = parseInt(e.target.value); $('val-h').textContent = e.target.value + '°'; };
    
    // Canvas FX
    $('btn-trails').onclick = () => { APP.vj.trailsEnabled = !APP.vj.trailsEnabled; $('btn-trails').classList.toggle('on'); };
    $('btn-rgb').onclick = () => { APP.vj.rgbEnabled = !APP.vj.rgbEnabled; $('btn-rgb').classList.toggle('on'); };
    $('btn-pixelate').onclick = () => { APP.vj.pixelateEnabled = !APP.vj.pixelateEnabled; $('btn-pixelate').classList.toggle('on'); };
    $('btn-bass-link').onclick = () => { APP.vj.rgbBassLink = !APP.vj.rgbBassLink; $('btn-bass-link').classList.toggle('on'); };
    $('sl-trail').oninput = e => { APP.vj.trailAlpha = parseInt(e.target.value) / 100; $('val-trail').textContent = (e.target.value / 100).toFixed(2); };
    $('sl-rgb').oninput = e => { APP.vj.rgbIntensity = parseInt(e.target.value); $('val-rgb').textContent = e.target.value; };
    $('sl-pix').oninput = e => { APP.vj.pixelSize = parseInt(e.target.value); $('val-pix').textContent = e.target.value; };
    
    // Overlays
    $('btn-vhs').onclick = toggleVHS;
    $('btn-crt').onclick = toggleCRT;
    $('btn-reset').onclick = masterReset;
    $('btn-fs').onclick = toggleFullscreen;
    
    // Theme
    document.querySelectorAll('.pal').forEach(p => p.onclick = () => setTheme(p.dataset.t));
    
    // Session
    $('btn-save').onclick = saveSession;
    $('btn-load').onclick = loadSession;
    $('btn-export-dna').onclick = exportDNA;
    $('btn-projector').onclick = openProjector;
    $('btn-capture30').onclick = capture30s;
    $('btn-enter-vr').onclick = enterVR;
    
    // P2P Guest Module Bindings
    $('btn-init-peer').onclick = () => {
        const peerId = 'DRIS_' + Math.random().toString(36).substr(2, 8).toUpperCase();
        initGuest(peerId);
        $('peer-id-display').value = 'Connecting...';
    };
    
    $('btn-connect-guest').onclick = () => {
        const remoteId = $('remote-peer-id').value.trim();
        if (remoteId) {
            APP.guest.connect(remoteId);
            $('guest-dot').classList.add('on');
        } else {
            log('ENTER_REMOTE_ID');
        }
    };
    
    $('btn-disconnect-guest').onclick = () => {
        disconnectGuest();
        $('guest-dot').classList.remove('on');
        $('peer-id-display').value = '';
    };
    $('btn-stereo').onclick = () => setSpatialMode('stereo');
    $('btn-spatial').onclick = () => setSpatialMode('3d');
    $('btn-dolby').onclick = () => setSpatialMode('dolby');
    $('audio-output').onchange = e => setAudioOutput(e.target.value);
    
    // Keyboard
    document.addEventListener('keydown', e => {
        if (e.target.tagName === 'INPUT') return;
        switch (e.key) {
            case ' ': e.preventDefault(); rotateMedia(); break;
            case 'Escape': masterReset(); break;
            case 'h': case 'H': toggleFullscreen(); break;
            case 'b': case 'B': toggleBug(); break;
            case 'v': case 'V': toggleVHS(); break;
            case 'c': case 'C': toggleCRT(); break;
            case 't': case 'T': APP.vj.trailsEnabled = !APP.vj.trailsEnabled; $('btn-trails').classList.toggle('on'); break;
            case 'r': case 'R': APP.vj.rgbEnabled = !APP.vj.rgbEnabled; $('btn-rgb').classList.toggle('on'); break;
            case 'p': case 'P': previousMedia(); break;
            case '1': impactStutter(); break;
            case '2': impactInvert(); break;
            case '3': impactCrush(); break;
        }
    });
    
    fetchCrypto();
    setInterval(fetchCrypto, 60000);
    loadSession();
    
    // Initialize XR (check for VR support)
    // XR, Audio outputs, and TimeMachine init on-demand (no permission prompts at startup)
    
    log('INIT_OK');
    
    // ═══════════════════════════════════════════════════════════════════════════
    // MATERIAL BLUR REVEAL
    // ═══════════════════════════════════════════════════════════════════════════
    const blurReveal = $('blur-reveal');
    if (blurReveal) {
        setTimeout(() => blurReveal.remove(), 600);
    }
    log('SOVEREIGN_CORE_ONLINE');
});
</script>
</body>
</html>
